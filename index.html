<!DOCTYPE html>
<html lang="zh-Hans">
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="小宇" />


    
    


<meta name="description" content="Shen Yu">
<meta property="og:type" content="website">
<meta property="og:title" content="小宇的博客">
<meta property="og:url" content="http://shenyu.wiki/index.html">
<meta property="og:site_name" content="小宇的博客">
<meta property="og:description" content="Shen Yu">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="小宇的博客">
<meta name="twitter:description" content="Shen Yu">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">
<link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css" rel="stylesheet">
<link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">

<!-- for mermaid -->


    <link rel="alternate" href="/atom.xml" title="小宇的博客" type="application/atom+xml">



    <link rel="shortcut icon" href="/uploads/siteicon.png">





    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">



<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>小宇的博客</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: false,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: true
    }
	
</script>


    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/uploads/avatar.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">小宇</a></h1>
        </hgroup>

        
        <p class="header-subtitle">statistics</p>
        

        
            <form id="search-form">
            <input type="text" id="local-search-input" name="q" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off" searchonload="true" />
            <i class="fa fa-times" onclick="resetSearch()"></i>
            </form>
            <div id="local-search-result"></div>
            <p class='no-result'>No results found <i class='fa fa-spinner fa-pulse'></i></p>
        


        <p class="header-subtitle">文章: 101 字数: 507393</p>
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-home icon-2x">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">归档</a></li>
                        
                            <li><a href="/tags/">标签</a></li>
                        
                            <li><a href="/map/">导航</a></li>
                        
                            <li><a href="/message/">留言</a></li>
                        
                            <li><a href="/about/">关于</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:shenyufly@163.com" title="Email"></a>
                            
                                <a class="fa GitHub" href="http://github.com/shenyuflying" title="GitHub"></a>
                            
                                <a class="fa RSS" href="http://1572339ac8.iok.la:34421" title="RSS"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/DTCC/">DTCC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ECPG/">ECPG</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Greenplum/">Greenplum</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux使用/">Linux使用</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux编程/">Linux编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OCI/">OCI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ODBC/">ODBC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Oracle/">Oracle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PLSQL/">PLSQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PostgreSQL/">PostgreSQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PostgreSQL使用/">PostgreSQL使用</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PostgreSQL内核/">PostgreSQL内核</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PostgreSQL接口/">PostgreSQL接口</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shell/">Shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/assembly/">assembly</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/">c</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cctree/">cctree</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cflow/">cflow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/codeviz/">codeviz</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/debug/">debug</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dns/">dns</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dnsmasq/">dnsmasq</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/doxygen/">doxygen</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/egypt/">egypt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/events/">events</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gdb/">gdb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/">golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gprof/">gprof</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kcachegrind/">kcachegrind</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mathjax/">mathjax</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nas/">nas</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nextcloud/">nextcloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sed/">sed</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/">shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/valgrind/">valgrind</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vim/">vim</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wget/">wget</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/基础知识/">基础知识</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/备份还原/">备份还原</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/小宇带你学PostgreSQL内核/">小宇带你学PostgreSQL内核</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/工具/">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/开源社区/">开源社区</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/技术分享/">技术分享</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/接口/">接口</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/操作系统/">操作系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据库/">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据库，PostgreSQL/">数据库，PostgreSQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/文章/">文章</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/旅行/">旅行</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/本地化/">本地化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/架构/">架构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/查询优化/">查询优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/树莓派/">树莓派</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/汇编调试方法/">汇编调试方法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/爱好/">爱好</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/编程/">编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/编程语言/">编程语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网站/">网站</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/语言层/">语言层</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/读书/">读书</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/调优/">调优</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://pages.github.com/">GitHub</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://moxfive.xyz/">MOxFIVE</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">专注于基础软件研发</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">小宇</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/uploads/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">小宇</a></h1>
            </hgroup>
            
            <p class="header-subtitle">statistics</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">归档</a></li>
                
                    <li><a href="/tags/">标签</a></li>
                
                    <li><a href="/map/">导航</a></li>
                
                    <li><a href="/message/">留言</a></li>
                
                    <li><a href="/about/">关于</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:shenyufly@163.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="http://github.com/shenyuflying" title="GitHub"></a>
                            
                                <a class="fa RSS" target="_blank" href="http://1572339ac8.iok.la:34421" title="RSS"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap">
  
    <article id="post-with-hold-cursor" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/06/12/with-hold-cursor/" class="article-date">
      <time datetime="2017-06-12T03:42:26.000Z" itemprop="datePublished">2017-06-12</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/12/with-hold-cursor/">with hold cursor</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <blockquote>
<p>最近在协助光大银行研发国产化平台，遇到了一个问题：客户这边需要fetch一条数据，然后根据取到的数据做update等等（不一定是对这刚取到的数据进行update），然后再fetch下一条，然后下一条取不出来。经过看客户这边的代码是因为多个fetch操作之间有update语句进行commit操作。commit会把cursor删掉，之后的fetch无法使用cursor。这时候with hold cursor就派上用场了。</p>
</blockquote>
<p>重现用例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">	EXEC SQL BEGIN DECLARE SECTION;</div><div class="line">		<span class="keyword">int</span> dboid;</div><div class="line">		<span class="keyword">char</span> dbname[<span class="number">256</span>] = &#123;<span class="number">0</span>&#125;;</div><div class="line">	EXEC SQL END   DECLARE SECTION;</div><div class="line"></div><div class="line">	EXEC SQL CONNECT TO postgres USER yshen;</div><div class="line"></div><div class="line">	EXEC SQL PREPARE stmt1 FROM <span class="string">"SELECT oid,datname FROM pg_database WHERE oid &gt; ?"</span>;</div><div class="line">	EXEC SQL DECLARE foo_bar CURSOR FOR stmt1;</div><div class="line"></div><div class="line">	<span class="comment">/* when end of result set reached, break out of while loop */</span></div><div class="line">	EXEC SQL WHENEVER NOT FOUND DO BREAK;</div><div class="line">	EXEC SQL WHENEVER SQLERROR STOP;</div><div class="line"></div><div class="line">	EXEC SQL OPEN foo_bar USING <span class="number">100</span>;</div><div class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</div><div class="line">	&#123;</div><div class="line">		    EXEC SQL FETCH NEXT FROM foo_bar INTO :dboid, :dbname;</div><div class="line">			<span class="built_in">printf</span>(<span class="string">"%d %s\n"</span>, dboid, dbname);</div><div class="line">		    EXEC SQL COMMIT;</div><div class="line">	&#125;</div><div class="line">	EXEC SQL CLOSE foo_bar;</div><div class="line">	EXEC SQL DEALLOCATE PREPARE stmt1;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这是数据库日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">LOG:  statement: begin transaction</div><div class="line">LOG:  execute &lt;unnamed&gt;: declare foo_bar cursor for SELECT oid,datname FROM sys_database WHERE oid &gt; $1</div><div class="line">DETAIL:  parameters: $1 = &apos;100&apos;</div><div class="line">LOG:  statement: fetch next from foo_bar</div><div class="line">LOG:  statement: commit</div><div class="line">LOG:  statement: begin transaction</div><div class="line">LOG:  statement: fetch next from foo_bar</div><div class="line">ERROR:  cursor &quot;foo_bar&quot; does not exist</div><div class="line">STATEMENT:  fetch next from foo_bar</div></pre></td></tr></table></figure>
<p>可以看到，commit会删掉定义的cursor，所以服务器报<code>ERROR:  cursor &quot;foo_bar&quot; does not exist</code>错误。</p>
<p>加上WITH HOLD 关键字即可解决这个问题：</p>
<p>EXEC SQL DECLARE foo_bar CURSOR <code>WITH HOLD</code> FOR stmt1;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">LOG:  statement: begin transaction</div><div class="line">LOG:  execute &lt;unnamed&gt;: declare foo_bar cursor with hold for SELECT oid,datname FROM pg_database WHERE oid &gt; $1</div><div class="line">DETAIL:  parameters: $1 = &apos;100&apos;</div><div class="line">LOG:  statement: fetch next from foo_bar</div><div class="line">LOG:  statement: commit</div><div class="line">LOG:  statement: begin transaction</div><div class="line">LOG:  statement: fetch next from foo_bar</div><div class="line">LOG:  statement: commit</div><div class="line">LOG:  statement: begin transaction</div><div class="line">LOG:  statement: fetch next from foo_bar</div><div class="line">LOG:  statement: close foo_bar</div><div class="line">LOG:  statement: deallocate &quot;stmt1&quot;</div><div class="line">LOG:  statement: commit</div></pre></td></tr></table></figure>
<p>可以看到数据是成功取出来了，服务器并没有报错。</p>
<p>如果还想看到更多此类文章，请移步到<a href="http://shenyu.wiki">小宇的博客</a>。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术分享/">技术分享</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ECPG/">ECPG</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PostgreSQL/">PostgreSQL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PostgreSQL接口/">PostgreSQL接口</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/数据库/">数据库</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-数据库使用bytea类型存取二进制文件" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/05/25/数据库使用bytea类型存取二进制文件/" class="article-date">
      <time datetime="2017-05-25T13:03:14.000Z" itemprop="datePublished">2017-05-25</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/25/数据库使用bytea类型存取二进制文件/">数据库使用bytea类型存取二进制文件</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <blockquote>
<p>数据库除了存取数字、文本等数据类型之外，还经常用来存取二进制文件类型。下面用OCI接口举例如何用数据库来存储图片。可以存取二进制文件类型的可以用char、text、bytea、lob等数据类型。正常要使用lob类型来存放二进制文件，因为lob类型支持随机访问，但是需要比较复杂的接口调用。这里用postresql的bytea数据类型来存放二进制文件。</p>
</blockquote>
<h2 id="表结构"><a href="#表结构" class="headerlink" title="表结构"></a>表结构</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">sample</span> (</div><div class="line">a <span class="built_in">text</span> primary <span class="keyword">key</span>,            <span class="comment">--name of file</span></div><div class="line">b bytea);                      <span class="comment">--data of file</span></div></pre></td></tr></table></figure>
<h2 id="图片导入到数据库"><a href="#图片导入到数据库" class="headerlink" title="图片导入到数据库"></a>图片导入到数据库</h2><center><img src="http://static.zybuluo.com/shenyuflying/8rpikj01xb3qbp621akbb9lo/image_1bfrp85vf1j851v581vo4dt882p9.png" alt="image_1bfrp85vf1j851v581vo4dt882p9.png-14.4kB"></center>

<h2 id="数据库导出到图片"><a href="#数据库导出到图片" class="headerlink" title="数据库导出到图片"></a>数据库导出到图片</h2><center><img src="http://static.zybuluo.com/shenyuflying/h9fs74rea0iba2cnvcngyygo/image_1bfrp8lv01oac1n8r1q021g0t5om.png" alt="image_1bfrp8lv01oac1n8r1q021g0t5om.png-16.3kB"></center><br><center><img src="http://static.zybuluo.com/shenyuflying/jm5w06dsy85czxswribdbjk7/image_1bfrp950m1v0710a710i6gd5tlt13.png" alt="image_1bfrp950m1v0710a710i6gd5tlt13.png-82.5kB"></center>


<h2 id="程序源码"><a href="#程序源码" class="headerlink" title="程序源码"></a>程序源码</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"oci.h"</span> <span class="comment">//OCI接口头文件</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"></div><div class="line">OCIEnv *envhp;      <span class="comment">//环境句柄</span></div><div class="line">OCIError *errhp;	<span class="comment">//错误句柄</span></div><div class="line">OCISvcCtx *svchp;	<span class="comment">//上下文句柄</span></div><div class="line">OCIStmt *stmthp = (OCIStmt *) <span class="literal">NULL</span>;<span class="comment">//语句句柄</span></div><div class="line"></div><div class="line"><span class="function">sword <span class="title">finish_demo</span><span class="params">(boolean loggedon, OCIEnv *envhp, OCISvcCtx *svchp,</span></span></div><div class="line">                   OCIError *errhp, OCIStmt *stmthp);</div><div class="line"><span class="function">sword <span class="title">init_handles</span><span class="params">(OCIEnv **envhp, OCIError **errhp)</span></span>;</div><div class="line"><span class="function">sword <span class="title">log_on</span><span class="params">(OCIEnv *envhp, OCIError *errhp,</span></span></div><div class="line">       text *uid, text *pwd, text *DbName);</div><div class="line"><span class="function"><span class="keyword">char</span> *<span class="title">file_to_binary_string</span><span class="params">(<span class="keyword">char</span> *filename)</span></span>;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">binary_string_to_file</span><span class="params">(<span class="keyword">char</span> *filename, <span class="keyword">char</span> * str)</span></span>;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">store</span><span class="params">(<span class="keyword">char</span> * filename)</span></span>;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">fetch</span><span class="params">(<span class="keyword">char</span> * filename)</span></span>;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">report_error</span><span class="params">(OCIError *errhp)</span>;</div><div class="line"></div><div class="line"><span class="comment">//初始化各种句柄</span></div><div class="line"><span class="function">sword</span></div><div class="line"><span class="title">init_handles</span><span class="params">(OCIEnv **envhp, OCIError **errhp)</span></div><div class="line">&#123;</div><div class="line">	<span class="built_in">printf</span>(<span class="string">"Environment setup ....\n"</span>);</div><div class="line"></div><div class="line">	<span class="comment">/* 初始化OCI应用环境 */</span></div><div class="line">	<span class="keyword">if</span> (OCIInitialize(OCI_DEFAULT, (dvoid *)<span class="number">0</span>,</div><div class="line">		(dvoid * (*)(dvoid *, <span class="keyword">size_t</span>))<span class="number">0</span>,</div><div class="line">		(dvoid * (*)(dvoid *, dvoid *, <span class="keyword">size_t</span>))<span class="number">0</span>,</div><div class="line">		(<span class="keyword">void</span> (*)(dvoid *, dvoid *))<span class="number">0</span>))</div><div class="line">	&#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"FAILED: OCIInitialize()\n"</span>);</div><div class="line">		<span class="keyword">return</span> OCI_ERROR;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/* 初始化环境句柄 */</span></div><div class="line">	<span class="keyword">if</span> (OCIEnvInit((OCIEnv **)envhp, (ub4)OCI_DEFAULT,</div><div class="line">		(<span class="keyword">size_t</span>)<span class="number">0</span>, (dvoid **)<span class="number">0</span>))</div><div class="line">	&#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"FAILED: OCIEnvInit()\n"</span>);</div><div class="line">		<span class="keyword">return</span> OCI_ERROR;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/* 从环境句柄上分配一个错误信息句柄 */</span></div><div class="line">	<span class="keyword">if</span> (OCIHandleAlloc((dvoid *)*envhp, (dvoid **)errhp,</div><div class="line">		(ub4)OCI_HTYPE_ERROR, (<span class="keyword">size_t</span>)<span class="number">0</span>, (dvoid **)<span class="number">0</span>))</div><div class="line">	&#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"FAILED: OCIHandleAlloc() on errhp\n"</span>);</div><div class="line">		<span class="keyword">return</span> OCI_ERROR;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> OCI_SUCCESS;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//使用给定的用户名和口令登录到指定的数据库服务上</span></div><div class="line"><span class="function">sword</span></div><div class="line"><span class="title">log_on</span><span class="params">(OCIEnv *envhp, OCIError *errhp,</span></div><div class="line">       text *uid, text *pwd, text *DbName)</div><div class="line">&#123;</div><div class="line">	<span class="built_in">printf</span>(<span class="string">"Logging on as %s  ....\n"</span>, uid);</div><div class="line"></div><div class="line">	<span class="comment">/* 连接数据库，在 OCILogon 中分配 Service handle */</span></div><div class="line">	<span class="keyword">if</span> (OCILogon(envhp, errhp, &amp;svchp, uid, (ub4)<span class="built_in">strlen</span>((<span class="keyword">char</span>*)uid),</div><div class="line">		pwd, (ub4)<span class="built_in">strlen</span>((<span class="keyword">char</span>*)pwd), DbName, (ub4)<span class="built_in">strlen</span>((<span class="keyword">char</span>*)DbName)))</div><div class="line">	&#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"FAILED: OCILogon()\n"</span>);</div><div class="line">		<span class="keyword">return</span> OCI_ERROR;</div><div class="line">	&#125;</div><div class="line">	<span class="built_in">printf</span>(<span class="string">"%s logged on.\n"</span>, uid);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> OCI_SUCCESS;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//断开连接，并释放各种句柄</span></div><div class="line"><span class="function">sword</span></div><div class="line"><span class="title">finish_demo</span><span class="params">(boolean loggedon, OCIEnv *envhp, OCISvcCtx *svchp,</span></div><div class="line">                   OCIError *errhp, OCIStmt *stmthp)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">if</span> (stmthp)</div><div class="line">		OCIHandleFree((dvoid *)stmthp, (ub4)OCI_HTYPE_STMT);</div><div class="line"></div><div class="line">	<span class="built_in">printf</span>(<span class="string">"logoff ...\n"</span>);</div><div class="line">	<span class="keyword">if</span> (loggedon)</div><div class="line">		OCILogoff(svchp, errhp);</div><div class="line"></div><div class="line">	<span class="built_in">printf</span>(<span class="string">"Freeing handles ...\n"</span>);</div><div class="line">	<span class="keyword">if</span> (svchp)</div><div class="line">		OCIHandleFree((dvoid *) svchp, (ub4)OCI_HTYPE_SVCCTX);</div><div class="line">	<span class="keyword">if</span> (errhp)</div><div class="line">		OCIHandleFree((dvoid *) errhp, (ub4)OCI_HTYPE_ERROR);</div><div class="line">	<span class="keyword">if</span> (envhp)</div><div class="line">		OCIHandleFree((dvoid *) envhp, (ub4)OCI_HTYPE_ENV);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> OCI_SUCCESS;</div><div class="line">&#125;</div><div class="line"><span class="comment">//打印错误信息</span></div><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">report_error</span><span class="params">(OCIError *errhp)</span></div><div class="line">&#123;</div><div class="line">	text  msgbuf[<span class="number">512</span>];</div><div class="line">	sb4   errcode = <span class="number">0</span>;</div><div class="line"></div><div class="line">	OCIErrorGet((dvoid *)errhp, (ub4)<span class="number">1</span>, (text *)<span class="literal">NULL</span>, &amp;errcode,</div><div class="line">		msgbuf, (ub4)<span class="keyword">sizeof</span>(msgbuf), (ub4)OCI_HTYPE_ERROR);</div><div class="line">	<span class="built_in">printf</span>(<span class="string">"ERROR CODE = %d"</span>, errcode);</div><div class="line">	<span class="built_in">printf</span>(<span class="string">"%.*s\n"</span>, <span class="number">512</span>, msgbuf);</div><div class="line"></div><div class="line">	<span class="keyword">return</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//on error return NULL</span></div><div class="line"><span class="comment">//on success return the binary string</span></div><div class="line"><span class="function"><span class="keyword">char</span> *<span class="title">file_to_binary_string</span><span class="params">(<span class="keyword">char</span> *filename)</span></span></div><div class="line">&#123;</div><div class="line">	FILE *fp = fopen(filename,<span class="string">"r"</span>);</div><div class="line">	<span class="keyword">char</span> *buffer = <span class="literal">NULL</span>;</div><div class="line">	<span class="keyword">size_t</span> pos = <span class="number">0</span>; <span class="comment">// file read position</span></div><div class="line">	<span class="keyword">size_t</span> size = <span class="number">1024</span>; <span class="comment">//how much mem allocated</span></div><div class="line">	<span class="keyword">size_t</span> nread = <span class="number">-1</span>;</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> ch; <span class="comment">// hold byte read from file</span></div><div class="line"></div><div class="line"></div><div class="line">	<span class="keyword">if</span> (fp == <span class="literal">NULL</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"error opening %s for reading\n"</span>, filename);</div><div class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	buffer = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(size);</div><div class="line"></div><div class="line">	<span class="comment">// read until end of file</span></div><div class="line">	<span class="keyword">while</span>( <span class="number">0</span> != (nread = fread(&amp;ch,<span class="number">1</span>,<span class="number">1</span>,fp)))</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">char</span> tmp[<span class="number">3</span>]=&#123;<span class="number">0</span>&#125;; <span class="comment">//hold the string form of binary data, i,e: FF</span></div><div class="line"></div><div class="line">		<span class="built_in">sprintf</span>(tmp,<span class="string">"%02x"</span>,ch);</div><div class="line">		buffer[pos++]=tmp[<span class="number">0</span>];</div><div class="line">		<span class="keyword">if</span> (pos==size)</div><div class="line">		&#123;</div><div class="line">			buffer = (<span class="keyword">char</span> *)<span class="built_in">realloc</span>(buffer, size*<span class="number">2</span>);</div><div class="line">			size = size*<span class="number">2</span>;</div><div class="line">		&#125;</div><div class="line">		buffer[pos++]=tmp[<span class="number">1</span>];</div><div class="line">		<span class="keyword">if</span> (pos==size)</div><div class="line">		&#123;</div><div class="line">			buffer = (<span class="keyword">char</span> *)<span class="built_in">realloc</span>(buffer, size*<span class="number">2</span>);</div><div class="line">			size = size*<span class="number">2</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	buffer[pos]=<span class="string">'\0'</span>; <span class="comment">// add tailing zero</span></div><div class="line"></div><div class="line">	fclose(fp);</div><div class="line"></div><div class="line">	<span class="comment">// the buffer should be freed by the caller</span></div><div class="line">	<span class="keyword">return</span> buffer;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">binary_string_to_file</span><span class="params">(<span class="keyword">char</span> *filename, <span class="keyword">char</span> *str)</span></span></div><div class="line">&#123;</div><div class="line">	FILE *fp = fopen(filename,<span class="string">"w"</span>);</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> table[<span class="string">'F'</span>+<span class="number">1</span>];</div><div class="line">	<span class="keyword">int</span> len = <span class="built_in">strlen</span>(str);</div><div class="line">	<span class="keyword">int</span> i;</div><div class="line"></div><div class="line">	table[<span class="string">'0'</span>]=<span class="number">0</span>;</div><div class="line">	table[<span class="string">'1'</span>]=<span class="number">1</span>;</div><div class="line">	table[<span class="string">'2'</span>]=<span class="number">2</span>;</div><div class="line">	table[<span class="string">'3'</span>]=<span class="number">3</span>;</div><div class="line">	table[<span class="string">'4'</span>]=<span class="number">4</span>;</div><div class="line">	table[<span class="string">'5'</span>]=<span class="number">5</span>;</div><div class="line">	table[<span class="string">'6'</span>]=<span class="number">6</span>;</div><div class="line">	table[<span class="string">'7'</span>]=<span class="number">7</span>;</div><div class="line">	table[<span class="string">'8'</span>]=<span class="number">8</span>;</div><div class="line">	table[<span class="string">'9'</span>]=<span class="number">9</span>;</div><div class="line">	table[<span class="string">'A'</span>]=<span class="number">10</span>;</div><div class="line">	table[<span class="string">'B'</span>]=<span class="number">11</span>;</div><div class="line">	table[<span class="string">'C'</span>]=<span class="number">12</span>;</div><div class="line">	table[<span class="string">'D'</span>]=<span class="number">13</span>;</div><div class="line">	table[<span class="string">'E'</span>]=<span class="number">14</span>;</div><div class="line">	table[<span class="string">'F'</span>]=<span class="number">15</span>;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (fp == <span class="literal">NULL</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"error opening %s for writing\n"</span>, filename);</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; len; i+=<span class="number">2</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">unsigned</span> <span class="keyword">char</span> bin;</div><div class="line">		bin = <span class="number">16</span>*table[str[i]] + table[str[i+<span class="number">1</span>]];</div><div class="line">		<span class="built_in">fprintf</span>(fp, <span class="string">"%c"</span>, bin);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	fclose(fp);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//store a file in to database</span></div><div class="line"><span class="comment">//should have a table like this:</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">//create table sample ( a text primary key, -- filename</span></div><div class="line"><span class="comment">//                      b bytea );          -- data</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">store</span><span class="params">(<span class="keyword">char</span> * filename)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">char</span> *str = <span class="literal">NULL</span>;</div><div class="line">	<span class="keyword">char</span> *sql = <span class="literal">NULL</span>;</div><div class="line"></div><div class="line">	str = file_to_binary_string(filename);</div><div class="line"></div><div class="line">	<span class="keyword">if</span>(str==<span class="literal">NULL</span>)</div><div class="line">	&#123;</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	sql = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="built_in">strlen</span>(str)+<span class="number">100</span>); <span class="comment">// more space for insert ...</span></div><div class="line">	<span class="built_in">memset</span>(sql,<span class="number">0</span>,<span class="built_in">strlen</span>(str)+<span class="number">100</span>);         <span class="comment">// more space for insert ...</span></div><div class="line"></div><div class="line">	<span class="built_in">sprintf</span>(sql, <span class="string">"insert into sample values('%s', '%s');"</span>, filename, str);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (OCIStmtPrepare(stmthp, errhp, (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)sql, (ub4)<span class="built_in">strlen</span>((<span class="keyword">char</span> *)sql),</div><div class="line">		(ub4)OCI_NTV_SYNTAX, (ub4)OCI_DEFAULT))</div><div class="line">	&#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"FAILED: OCIStmtPrepare() insert\n"</span>);</div><div class="line">		finish_demo(TRUE, envhp, svchp, errhp, stmthp);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//非查询类型语句，iters参数必需&gt;=1</span></div><div class="line">	<span class="keyword">if</span> (OCIStmtExecute(svchp, stmthp, errhp, (ub4)<span class="number">1</span>, (ub4)<span class="number">0</span>,</div><div class="line">		(CONST OCISnapshot*)<span class="number">0</span>, (OCISnapshot*)<span class="number">0</span>,</div><div class="line">		(ub4)OCI_DEFAULT))</div><div class="line">	&#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"FAILED: OCIStmtExecute() insert\n"</span>);</div><div class="line">		finish_demo(TRUE, envhp, svchp, errhp, stmthp);</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="built_in">free</span>(str);</div><div class="line">	<span class="built_in">free</span>(sql);</div><div class="line"></div><div class="line">	<span class="built_in">printf</span>(<span class="string">"ok!\n"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">fetch</span><span class="params">(<span class="keyword">char</span> * filename)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">char</span> sql[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;; <span class="comment">// should be enough</span></div><div class="line">	OCIParam     *mypard = (OCIParam *) <span class="number">0</span>;</div><div class="line">	ub2          dtype;</div><div class="line">	text         *col_name;</div><div class="line">	ub4          counter, col_name_len, char_semantics;</div><div class="line">	ub2          col_width;</div><div class="line">	ub4 dsize = <span class="number">100</span>*<span class="number">1024</span>*<span class="number">1024</span>; <span class="comment">//100M should be enough</span></div><div class="line">	<span class="keyword">char</span> *str = <span class="literal">NULL</span>;</div><div class="line">	OCIDefine *bndhp;</div><div class="line">	ub4 stmrow = <span class="number">0</span>;</div><div class="line"></div><div class="line">	str=(<span class="keyword">char</span> *)<span class="built_in">malloc</span>(dsize+<span class="number">1</span>);</div><div class="line">	<span class="built_in">memset</span>(str,<span class="number">0</span>,dsize+<span class="number">1</span>);</div><div class="line"></div><div class="line">	<span class="built_in">sprintf</span>(sql, <span class="string">"select b from sample where a = '%s'"</span>, filename);</div><div class="line"></div><div class="line">	<span class="comment">//准备查询语句</span></div><div class="line">	<span class="keyword">if</span> (OCIStmtPrepare(stmthp, errhp, sql, (ub4)<span class="built_in">strlen</span>((<span class="keyword">char</span> *)sql),</div><div class="line">		(ub4)OCI_NTV_SYNTAX, (ub4)OCI_DEFAULT))</div><div class="line">	&#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"FAILED: OCIStmtPrepare() select\n"</span>);</div><div class="line">		report_error(errhp);</div><div class="line">		<span class="keyword">return</span> ;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//执行查询语句</span></div><div class="line">	<span class="keyword">if</span> (OCIStmtExecute(svchp, stmthp, errhp, (ub4)<span class="number">0</span>, (ub4)<span class="number">0</span>,</div><div class="line">		(CONST OCISnapshot*)<span class="number">0</span>, (OCISnapshot*)<span class="number">0</span>,</div><div class="line">		(ub4)OCI_DEFAULT))</div><div class="line">	&#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"FAILED: OCIStmtExecute() select\n"</span>);</div><div class="line">		report_error(errhp);</div><div class="line">		<span class="keyword">return</span> ;</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="comment">// bind</span></div><div class="line">	<span class="keyword">if</span> (OCIDefineByPos(stmthp, &amp;bndhp, errhp, <span class="number">1</span>,</div><div class="line">		(dvoid *)str, (sb4)dsize, (ub2)SQLT_STR,</div><div class="line">		(dvoid *)<span class="number">0</span>, (ub2 *)<span class="number">0</span>, (ub2 *)<span class="number">0</span>, (ub4)OCI_DEFAULT))</div><div class="line">	&#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"FAILED: OCIDefineByPos()\n"</span>);</div><div class="line">		report_error(errhp);</div><div class="line">		<span class="keyword">return</span> ;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (OCIStmtFetch(stmthp, errhp, <span class="number">1</span>, OCI_FETCH_NEXT, <span class="number">0</span>) == OCI_ERROR)</div><div class="line">	&#123;</div><div class="line"></div><div class="line">		<span class="built_in">printf</span>(<span class="string">"FAILED: OCIStmtFetch() select\n"</span>);</div><div class="line">		report_error(errhp);</div><div class="line">		<span class="keyword">return</span> ;</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	OCIAttrGet(stmthp, OCI_HTYPE_STMT, &amp;stmrow, <span class="number">0</span>, OCI_ATTR_ROW_COUNT, errhp);</div><div class="line"></div><div class="line">	<span class="keyword">if</span>(stmrow == <span class="number">0</span>)<span class="comment">//没有新行被获取，那么跳出</span></div><div class="line">	&#123;</div><div class="line"></div><div class="line">		<span class="built_in">printf</span>(<span class="string">"no rows fetched\n"</span>);</div><div class="line">		<span class="keyword">return</span> ;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="built_in">printf</span>(<span class="string">"提取到了%d行记录\n"</span>, stmrow);</div><div class="line"></div><div class="line"></div><div class="line">	binary_string_to_file(filename, str);</div><div class="line"></div><div class="line">	<span class="built_in">free</span>(str);</div><div class="line">	<span class="built_in">printf</span>(<span class="string">"ok!\n"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//主程序入口</span></div><div class="line"><span class="function"><span class="keyword">int</span></span></div><div class="line"><span class="title">main</span><span class="params">()</span></div><div class="line">&#123;</div><div class="line">	text *DbName =(text*)<span class="string">"Kingbase"</span>; <span class="comment">//配置文件 sys_service.conf 中配置的数据源名</span></div><div class="line">	text *username = (text *)<span class="string">"SYSTEM"</span>; <span class="comment">//用户名</span></div><div class="line">	text *password = (text *)<span class="string">"MANAGER"</span>; <span class="comment">//口令</span></div><div class="line">	<span class="keyword">int</span> logged_on = FALSE;</div><div class="line">	<span class="keyword">int</span> choice = <span class="number">0</span>;</div><div class="line">	<span class="keyword">char</span> filename[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</div><div class="line"></div><div class="line">	<span class="comment">//初始化各种句柄</span></div><div class="line">	<span class="keyword">if</span> (init_handles(&amp;envhp, &amp;errhp))</div><div class="line">	&#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"FAILED: init_handles()\n"</span>);</div><div class="line">		<span class="keyword">return</span> finish_demo(logged_on, envhp, svchp, errhp, stmthp);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//登录到数据库服务</span></div><div class="line">	<span class="keyword">if</span> (log_on(envhp, errhp, username, password, DbName))</div><div class="line">	&#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"FAILED: log_on()\n"</span>);</div><div class="line">		<span class="keyword">return</span> finish_demo(logged_on, envhp, svchp, errhp, stmthp);</div><div class="line">	&#125;</div><div class="line">	logged_on = TRUE;</div><div class="line">	<span class="keyword">if</span> (OCIHandleAlloc((dvoid *)envhp, (dvoid **)&amp;stmthp,</div><div class="line">		(ub4)OCI_HTYPE_STMT, (CONST <span class="keyword">size_t</span>)<span class="number">0</span>, (dvoid **) <span class="number">0</span>))</div><div class="line">	&#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"FAILED: alloc statement handle\n"</span>);</div><div class="line">		<span class="keyword">return</span> finish_demo(logged_on, envhp, svchp, errhp, stmthp);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="built_in">printf</span>(<span class="string">"\n1)store a file."</span></div><div class="line">	       <span class="string">"\n2)fetch a file."</span></div><div class="line">	       <span class="string">"\nyour choice : "</span>);</div><div class="line">	<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;choice);</div><div class="line"></div><div class="line">	<span class="keyword">switch</span>(choice)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">			<span class="built_in">printf</span>(<span class="string">"FileName : "</span>);</div><div class="line">			<span class="built_in">scanf</span>(<span class="string">"%s"</span>, filename);</div><div class="line">			store(filename);</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> <span class="number">2</span>:</div><div class="line">			<span class="built_in">printf</span>(<span class="string">"FileName : "</span>);</div><div class="line">			<span class="built_in">scanf</span>(<span class="string">"%s"</span>, filename);</div><div class="line">			fetch(filename);</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">default</span>:</div><div class="line">			<span class="built_in">printf</span>(<span class="string">"bad choice!\n"</span>);</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//登出数据库服务，并清理各种句柄</span></div><div class="line">	<span class="keyword">return</span> finish_demo(logged_on, envhp, svchp, errhp, stmthp);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果还想看到更多此类文章，请移步到<a href="http://shenyu.wiki">小宇的博客</a>。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术分享/">技术分享</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OCI/">OCI</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Oracle/">Oracle</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/数据库/">数据库</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-DTCC2017" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/05/25/DTCC2017/" class="article-date">
      <time datetime="2017-05-25T11:36:14.000Z" itemprop="datePublished">2017-05-25</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/25/DTCC2017/">DTCC2017</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p><img src="http://static.zybuluo.com/shenyuflying/cyto7qzlpnwndm4z2ki4aagy/image_1bgvne5cr1ktvr0a1qdc1247g73m.png" alt="dtcc2017"></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/events/">events</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DTCC/">DTCC</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/events/">events</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/数据库/">数据库</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-postgres-identifier-and-keyworkd" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/05/10/postgres-identifier-and-keyworkd/" class="article-date">
      <time datetime="2017-05-10T02:17:58.000Z" itemprop="datePublished">2017-05-10</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/10/postgres-identifier-and-keyworkd/">postgres identifier and keyword</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="identifier"><a href="#identifier" class="headerlink" title="identifier"></a>identifier</h2><p>identifier is defined in scan.l just like below</p>
<center><img src="http://static.zybuluo.com/shenyuflying/r9ofw87pnanbqn41qm0zib7e/image_1bfnvt1dsi911hs41pml1qmm1sf2m.png" alt="image_1bfnvt1dsi911hs41pml1qmm1sf2m.png-21.2kB"></center>

<p>it is a string start with <code>letter</code> or <code>-</code> and might following with numbers.</p>
<h2 id="keyword"><a href="#keyword" class="headerlink" title="keyword"></a>keyword</h2><p>keywords is defined in <code>kwlist.h</code> just like below</p>
<center><img src="http://static.zybuluo.com/shenyuflying/ikrcc22t1eko062lv1l818dd/image_1bfo0372n16ohq9165i18k518sl13.png" alt="image_1bfo0372n16ohq9165i18k518sl13.png-91.6kB"></center>

<p>the name of keyword is the string scanned by the lexer.<br>the value is defined in the lexer <code>%token &lt;keyword&gt;</code> session and later convert to an enum value.<br>we have four categories of keyword:</p>
<ul>
<li>reserved key workd: keywords that are usable only as ColLabel( select a as col1 …)</li>
<li>unreserved keyword : keyword can be used as any type of name.</li>
<li>column keyword: keywords that can be column, table, etc, names</li>
<li>function name keyword: keywords that can be function names</li>
</ul>
<h2 id="relation-of-identifier-and-keyword"><a href="#relation-of-identifier-and-keyword" class="headerlink" title="relation of identifier and keyword"></a>relation of identifier and keyword</h2><p>in short, keyword is a subset of identifiers. in the lex scanner, when we have an identifier matched, we first check to see if it is a keyword by <code>ScanKeywordLookup</code>. the function take a binary search in the keyword list. if a keyword is found the enum value of the keyword is returned to the parser.</p>
<p>if the identifier is not a keyword, we truncate the string in to NAMEDATELEN(which is 64 byte long) and convert into lower case. after we have done the casting, we store the string value of the identifier into <code>yylval-&gt;str</code> and return <code>IDENT</code> to the parser.</p>
<center><img src="http://static.zybuluo.com/shenyuflying/a147jgs1l59oz60obsmlbbjd/image_1bfnvkmf2kog7pd1ihf29j7ca9.png" alt="image_1bfnvkmf2kog7pd1ihf29j7ca9.png-99.5kB"></center>

<h2 id="more-about-key-word-categories"><a href="#more-about-key-word-categories" class="headerlink" title="more about key word categories"></a>more about key word categories</h2><p>the reason why we have four categories of keyword is to allow keyword to use in more cases. suppose we only have one category keyword, the reserved keyword. the keyword, for example <code>NUMERIC</code> might not be used as colnames.</p>
<p>by putting <code>NUMERIC</code> into unreserved keyword category we allow it to be used as column names.</p>
<center><img src="http://static.zybuluo.com/shenyuflying/ywt2xxzhx52c2wra5o189cx3/image_1bfo1o0g11nq44chrtqa9f1ane1t.png" alt="image_1bfo1o0g11nq44chrtqa9f1ane1t.png-34.7kB"></center>

<p>however, the <code>SELECT</code> is a reserved keyword which cannot be used as column names, else we might have a sql query like this<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select select from select;</div></pre></td></tr></table></figure></p>
<p>this will make the parser confused.</p>
<h2 id="add-new-key-word"><a href="#add-new-key-word" class="headerlink" title="add new key word"></a>add new key word</h2><p>if you want to make any keyword changes, for example add a new keyword, you can do it like this:</p>
<ol>
<li>add it in <code>kwlist.h</code> and fill in the right category</li>
<li>add it in <code>gram.y</code> <code>%token</code> section so a enum value for it can be generated</li>
<li>add your keyword into the right place of the rules in <code>gram.y</code></li>
<li>complie and test</li>
</ol>
<p>如果还想看到更多此类文章，请移步到<a href="http://shenyu.wiki">小宇的博客</a>。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术分享/">技术分享</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PostgreSQL/">PostgreSQL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PostgreSQL内核/">PostgreSQL内核</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/数据库/">数据库</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/语言层/">语言层</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-获取字段分组个数" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/05/06/获取字段分组个数/" class="article-date">
      <time datetime="2017-05-06T07:30:57.000Z" itemprop="datePublished">2017-05-06</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/06/获取字段分组个数/">获取字段分组个数</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <blockquote>
<p>现场应用有一个需求，是获取字段分组个数。这里简单介绍2种实现方法。</p>
</blockquote>
<p>表中的数据如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">TEST=# select * from tab1;</div><div class="line"> COL</div><div class="line">-----</div><div class="line">  10</div><div class="line">  20</div><div class="line">  10</div><div class="line">  20</div><div class="line">  10</div><div class="line">(5 rows)</div></pre></td></tr></table></figure></p>
<h2 id="方法1"><a href="#方法1" class="headerlink" title="方法1"></a>方法1</h2><p>先用<code>group by</code>进行分组，可以看到有2组<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">TEST=# select  count(*) from tab1 group by col;</div><div class="line"> COUNT</div><div class="line">-------</div><div class="line">     2</div><div class="line">     3</div><div class="line">(2 rows)</div></pre></td></tr></table></figure></p>
<p>在这个基础上来获取记录条数，这里用到了子查询。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">TEST=# select count(*) from (select  count(*) from tab1 group by col);</div><div class="line"> COUNT</div><div class="line">-------</div><div class="line">     2</div><div class="line">(1 row)</div></pre></td></tr></table></figure></p>
<p>结果就是有两个分组。</p>
<h2 id="方法2"><a href="#方法2" class="headerlink" title="方法2"></a>方法2</h2><p>先用<code>distinct</code>来去重复，再<code>count</code>计算去重后的条数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">TEST=#  select count(distinct(col)) from tab1 ;</div><div class="line"> COUNT</div><div class="line">-------</div><div class="line">     2</div><div class="line">(1 row)</div></pre></td></tr></table></figure></p>
<h2 id="性能对比"><a href="#性能对比" class="headerlink" title="性能对比"></a>性能对比</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">TEST=# explain analyze select count(*) from (select  count(*) from tab1 group by col);</div><div class="line">                                                       QUERY PLAN</div><div class="line">------------------------------------------------------------------------------------------------------------------------</div><div class="line"> Aggregate  (cost=3080.65..3080.66 rows=1 width=0) (actual time=173.733..173.733 rows=1 loops=1)</div><div class="line">   -&gt;  HashAggregate  (cost=3080.60..3080.62 rows=2 width=4) (actual time=173.723..173.726 rows=2 loops=1)</div><div class="line">         -&gt;  Seq Scan on TAB1  (cost=0.00..2261.40 rows=163840 width=4) (actual time=0.015..54.264 rows=163840 loops=1)</div><div class="line"> Total runtime: 173.841 ms</div><div class="line">(4 rows)</div><div class="line"></div><div class="line">TEST=# explain analyze  select count(distinct(col)) from tab1 ;</div><div class="line">                                                    QUERY PLAN</div><div class="line">------------------------------------------------------------------------------------------------------------------</div><div class="line"> Aggregate  (cost=2671.00..2671.01 rows=1 width=4) (actual time=189.389..189.389 rows=1 loops=1)</div><div class="line">   -&gt;  Seq Scan on TAB1  (cost=0.00..2261.40 rows=163840 width=4) (actual time=0.021..54.395 rows=163840 loops=1)</div><div class="line"> Total runtime: 189.468 ms</div><div class="line">(3 rows)</div></pre></td></tr></table></figure>
<p>可见第一种方法性能更好，区别主要是第一种方法用的HashAggregate  start time 比较小。但是区别不是很明显。</p>
<p>如果还想看到更多此类文章，请移步到<a href="http://shenyu.wiki">小宇的博客</a>。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术分享/">技术分享</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/数据库/">数据库</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-裤子把人搞死？一个库引发的悲剧" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/04/22/裤子把人搞死？一个库引发的悲剧/" class="article-date">
      <time datetime="2017-04-22T05:58:59.000Z" itemprop="datePublished">2017-04-22</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/22/裤子把人搞死？一个库引发的悲剧/">裤子把人搞死？一个库引发的悲剧</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <blockquote>
<p>穿个裤子，裤子破个洞，人应该没事吧？现实是人有可能挂掉！悲剧正在发生，一些破库经常搞挂服务器。</p>
</blockquote>
<h2 id="问题现象"><a href="#问题现象" class="headerlink" title="问题现象"></a>问题现象</h2><p>服务器coredump，堆栈显示如下：</p>
<p><img src="http://static.zybuluo.com/shenyuflying/kxnvjyy0kkifws502en6rkvu/image_1bea3g6li19431k0dpq61fag16pn1t.png" alt="**x**"><br>数据库宕记前日志显示如下：</p>
<p><img src="http://static.zybuluo.com/shenyuflying/7ut8qfw12wql4rrb5x1hxl54/image_1be7j5vnq1iqh1ub1b0bcqm17oi9.png" alt="image_1be7j5vnq1iqh1ub1b0bcqm17oi9.png-3786.2kB"></p>
<p>通过数据库日志来看，这条语句为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select * from D5000.OP_ANA_STAT_SAMPLE_MONTH@kdb;</div></pre></td></tr></table></figure></p>
<p>手动执行这条语句，并没有引发coredump。可见并不是一个频繁发生的问题。</p>
<p>堆栈信息可知，当时在执行一条pbe语句，在execute阶段通过dblink获取数据时，由于某种原因失败，在释放内存的时候core在了odbc驱动之中。栈顶函数为free，怀疑是odbc驱动内存释放不当导致。</p>
<h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><h3 id="错误行定位"><a href="#错误行定位" class="headerlink" title="错误行定位"></a>错误行定位</h3><p>由于odbc没有显示行号，需要根据反汇编来确定出错行的位置。根据堆栈信息，出错的指令地址位于0x2aba66c31370位置。</p>
<p>该处汇编显示为：</p>
<center> <img src="http://static.zybuluo.com/shenyuflying/0ys6sy1fy85kiq8eofdgpu4m/image_1be76mofi1gucdfu1n8214dl17809.png" alt="image_1be76mofi1gucdfu1n8214dl17809.png-3387.8kB"> </center>

<p>当时的寄存器显示为：</p>
<center> <img src="http://static.zybuluo.com/shenyuflying/gdrztnkejhms20aij08fnaxd/image_1be770h6n1jdqp6u12ja1ltp1cvvm.png" alt="image_1be770h6n1jdqp6u12ja1ltp1cvvm.png-3299.7kB"> </center>

<p>通过反汇编定位到出错行为：511行。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="number">491</span> <span class="keyword">void</span></div><div class="line"><span class="number">492</span> QR_free_memory(QResultClass *self)</div><div class="line"><span class="number">493</span> &#123;</div><div class="line"><span class="number">494</span> ›   <span class="keyword">register</span> <span class="keyword">int</span> lf,</div><div class="line"><span class="number">495</span> ›   ›   ›   ›   row;</div><div class="line"><span class="number">496</span> ›   <span class="keyword">register</span> TupleField *tuple = self-&gt;backend_tuples;</div><div class="line"><span class="number">497</span> ›   SQLLEN› ›   num_backend_rows = self-&gt;num_backend_rows;</div><div class="line"><span class="number">498</span> ›   <span class="keyword">int</span>››   ›   num_fields = self-&gt;num_fields;</div><div class="line"><span class="number">499</span></div><div class="line"><span class="number">500</span> ›   mylog(<span class="string">"QResult: free memory in %x, fcount = %d\n"</span>, self, num_backend_rows);</div><div class="line"><span class="number">501</span> ›   <span class="keyword">if</span> (self-&gt;backend_tuples)</div><div class="line"><span class="number">502</span> ›   &#123;</div><div class="line"><span class="number">503</span> ›   ›   <span class="keyword">for</span> (row = <span class="number">0</span>; row &lt; num_backend_rows; row++)</div><div class="line"><span class="number">504</span> ›   ›   &#123;</div><div class="line"><span class="number">505</span> ›   ›   ›   mylog(<span class="string">"row = %d, num_fields = %d\n"</span>, row, num_fields);</div><div class="line"><span class="number">506</span> ›   ›   ›   <span class="keyword">for</span> (lf = <span class="number">0</span>; lf &lt; num_fields; lf++)</div><div class="line"><span class="number">507</span> ›   ›   ›   &#123;</div><div class="line"><span class="number">508</span> ›   ›   ›   ›   <span class="keyword">if</span> (tuple[lf].value != <span class="literal">NULL</span>)</div><div class="line"><span class="number">509</span> ›   ›   ›   ›   &#123;</div><div class="line"><span class="number">510</span> ›   ›   ›   ›   ›   mylog(<span class="string">"free [lf=%d] %x\n"</span>, lf, tuple[lf].value);</div><div class="line"><span class="number">511</span> ›   ›   ›   ›   ›   <span class="built_in">free</span>(tuple[lf].value);    ---出错行</div><div class="line"><span class="number">512</span> ›   ›   ›   ›   ›   tuple[lf].value = <span class="literal">NULL</span>;</div><div class="line"><span class="number">513</span> ›   ›   ›   ›   &#125;</div><div class="line"><span class="number">514</span> ›   ›   ›   &#125;</div><div class="line"><span class="number">515</span> ›   ›   ›   tuple += num_fields;›   <span class="comment">/* next row */</span></div><div class="line"><span class="number">516</span> ›   ›   &#125;</div><div class="line"><span class="number">517</span></div><div class="line"><span class="number">518</span> ›   ›   <span class="built_in">free</span>(self-&gt;backend_tuples);</div><div class="line"><span class="number">519</span> ›   ›   <span class="comment">//added by YJL 2003-03-18</span></div><div class="line"><span class="number">520</span> ›   ›   self-&gt;backend_tuples=<span class="literal">NULL</span>;</div><div class="line"><span class="number">521</span> ›   ›   self-&gt;count_backend_allocated = <span class="number">0</span>;</div><div class="line"><span class="number">522</span> ›   ›   self-&gt;backend_tuples = <span class="literal">NULL</span>;</div><div class="line"><span class="number">523</span> ›   &#125;</div></pre></td></tr></table></figure></p>
<p>free的地址为：0x286f1。</p>
<p>通过对比堆上地址来看:<br>堆地址范围：  0x2eb465c8<br>指令地址范围：0x5f0e9c 附近</p>
<p>显然free的地址0x286f1为无效地址。</p>
<h3 id="错误行dblink-c-789"><a href="#错误行dblink-c-789" class="headerlink" title="错误行dblink.c:789"></a>错误行dblink.c:789</h3><p>该处能够直接对应到行号，该行附近的代码如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="number">780</span></div><div class="line"><span class="number">781</span> ›   ›   ›   tuplebuf = palloc(<span class="keyword">sizeof</span>(<span class="keyword">char</span> *) * query-&gt;colcount);</div><div class="line"><span class="number">782</span></div><div class="line"><span class="number">783</span> ›   ›   ›   <span class="keyword">while</span>((rc = SQLFetch(query-&gt;hstmt)) != SQL_NO_DATA)</div><div class="line"><span class="number">784</span> ›   ›   ›   &#123;</div><div class="line"><span class="number">785</span> ›   ›   ›   ›   HeapTuple›  tuple;</div><div class="line"><span class="number">786</span> ›   ›   ›   ›   <span class="keyword">int</span>         offset;</div><div class="line"><span class="number">787</span> ›   ›   ›   ›</div><div class="line"><span class="number">788</span> ›   ›   ›   ›   <span class="keyword">if</span> (rc != SQL_SUCCESS &amp;&amp; rc != SQL_SUCCESS_WITH_INFO)</div><div class="line"><span class="number">789</span> ›   ›   ›   ›   ›   DBLinkReport(query, handle);</div><div class="line"><span class="number">790</span></div><div class="line"><span class="number">791</span> ›   ›   ›   ›   <span class="keyword">for</span>(offset = <span class="number">0</span>; offset &lt; query-&gt;fetchedrows; offset++)</div><div class="line"><span class="number">792</span> ›   ›   ›   ›   &#123;</div><div class="line"><span class="number">793</span> ›   ›   ›   ›   ›   <span class="keyword">for</span>(i = <span class="number">0</span>; i&lt; query-&gt;colcount; i++)</div><div class="line"><span class="number">794</span> ›   ›   ›   ›   ›   &#123;</div></pre></td></tr></table></figure></p>
<p>可见，SQLFetch函数失败，程序调用DBLinkReport报错退出。报错信息通过gdb能够看到如下内容：</p>
<p><img src="http://static.zybuluo.com/shenyuflying/hprhegmbg94f8vat7jggh3jq/image_1bea3hfad80cat3mmr1u0q5ko2a.png" alt="image_1bea3hfad80cat3mmr1u0q5ko2a.png-186.6kB"></p>
<p>报的错误为：<code>Error Fetching next group</code></p>
<p>根据报错信息，对应到odbc代码中898行位置：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">in function</div><div class="line">   <span class="number">886</span> ›   ›   ›   <span class="built_in">sprintf</span>(fetch, <span class="string">"fetch %d in %s"</span>, fetch_size, self-&gt;cursor);</div><div class="line">   <span class="number">887</span></div><div class="line">   <span class="number">888</span> ›   ›   ›   mylog(<span class="string">"next_tuple: sending actual fetch (%d) query '%s'\n"</span>, fetch_size, fetch);</div><div class="line">   <span class="number">889</span></div><div class="line">   <span class="number">890</span> ›   ›   ›   <span class="comment">/* don't read ahead for the next tuple (self) ! */</span></div><div class="line">   <span class="number">891</span> ›   ›   ›   qi.row_size = self-&gt;cache_size;</div><div class="line">   <span class="number">892</span> ›   ›   ›   qi.result_in = self;</div><div class="line">   <span class="number">893</span> ›   ›   ›   qi.cursor = <span class="literal">NULL</span>;</div><div class="line">   <span class="number">894</span> ›   ›   ›   res = DBC_send_query(self-&gt;conn, fetch, &amp;qi, CLEAR_RESULT_ON_ABORT);</div><div class="line">   <span class="number">895</span> ›   ›   ›   <span class="keyword">if</span> (res == <span class="literal">NULL</span>)</div><div class="line">   <span class="number">896</span> ›   ›   ›   &#123;</div><div class="line">   <span class="number">897</span> ›   ›   ›   ›   self-&gt;status = KBRES_FATAL_ERROR;</div><div class="line">   <span class="number">898</span> ›   ›   ›   ›   QR_set_message(self, <span class="string">"Error fetching next group."</span>, <span class="number">1</span>);</div><div class="line">   <span class="number">899</span> ›   ›   ›   ›   <span class="keyword">return</span> FALSE;</div><div class="line">   <span class="number">900</span> ›   ›   ›   &#125;</div><div class="line">   <span class="number">901</span> ›   ›   ›   self-&gt;inTuples = TRUE;</div></pre></td></tr></table></figure></p>
<p>根据代码，可以看到当时<code>DBC_send_query</code>在执行<code>fetch %d in %s</code>的时候失败。</p>
<h3 id="宕机前调用堆栈"><a href="#宕机前调用堆栈" class="headerlink" title="宕机前调用堆栈"></a>宕机前调用堆栈</h3><p>目前看到的是宕记时候的堆栈，现在根据已知信息还原coredump前调用的堆栈：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">DBC_send_query   --失败返回NULL--&gt;                                QR_next_tuple</div><div class="line">QR_next_tuple    --报错信息Error fetching_next group 返回FALSE--&gt; STMT_Fetch</div><div class="line">STMT_Fetch       --SQLSTATE设为HY000返回SQLERROR--&gt;               MY_ExtendedFetch</div><div class="line">MY_ExtendedFetch --返回SQLERROR--&gt;                                SQLFetch</div><div class="line">SQLFetch         --返回SQLERROR--&gt;                                dblink_record</div><div class="line">dblink_record    --调用--&gt;                                        DBLinkReport</div><div class="line">DBLinkReport     --调用--&gt;                                        SQLFreeHandle</div><div class="line">SQLFreeHandle    --经过若干调用--&gt;                                QR_free_memory</div></pre></td></tr></table></figure>
<h2 id="问题重现"><a href="#问题重现" class="headerlink" title="问题重现"></a>问题重现</h2><p>仿照上一节的推理，如果DBC_send_query失败，问题会不会重现？<br>那么在DBC_send_query处打断点，接下来c，直到有fetch 1024的时候，强制DBC_send_query返回0<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">(gdb) b DBC_send_query</div><div class="line">Function &quot;DBC_send_query&quot; not defined.</div><div class="line">Make breakpoint pending on future shared library load? (y or [n]) y</div><div class="line">Breakpoint 1 (DBC_send_query) pending.</div><div class="line">(gdb) c</div><div class="line">Continuing.</div><div class="line">[New Thread 0x40a74940 (LWP 15989)]</div><div class="line">[Switching to Thread 0x42332940 (LWP 15981)]</div><div class="line"></div><div class="line">Breakpoint 1, DBC_send_query (self=0x9cf5e40, query=0x2aaade6554d9 &quot; &quot;, qi=0x0, flag=1) at connection.c:3820</div><div class="line">3820		QResultClass *cmdres = NULL,</div><div class="line">(gdb) c</div><div class="line">Continuing.</div><div class="line"></div><div class="line">Breakpoint 1, DBC_send_query (self=0x9cf5e40, query=0x9ebed80 &quot;set DateStyle to &apos;ISO&apos;&quot;, qi=0x0, flag=0) at connection.c:3820</div><div class="line">3820		QResultClass *cmdres = NULL,</div><div class="line">(gdb)</div><div class="line">Continuing.</div><div class="line"></div><div class="line"></div><div class="line">Breakpoint 1, DBC_send_query (self=0x9cf5e40, query=0x9ee1240 &quot;declare SQL_CUR0x9ec1c20 scroll cursor for SELECT * FROM \&quot;TB1\&quot; WHERE 1 = 0&quot;, qi=0x0, flag=4) at connection.c:3820</div><div class="line">3820		QResultClass *cmdres = NULL,</div><div class="line">(gdb)</div><div class="line">Continuing.</div><div class="line"></div><div class="line">Breakpoint 1, DBC_send_query (self=0x9cf5e40, query=0x2aaade6548e5 &quot;BEGIN&quot;, qi=0x0, flag=1) at connection.c:3820</div><div class="line">3820		QResultClass *cmdres = NULL,</div><div class="line">(gdb)</div><div class="line">Continuing.</div><div class="line"></div><div class="line">Breakpoint 1, DBC_send_query (self=0x9cf5e40, query=0x4229ee50 &quot;fetch 0 in SQL_CUR0x9ec1c20&quot;, qi=0x4229eee0, flag=0) at connection.c:3820</div><div class="line">3820		QResultClass *cmdres = NULL,</div><div class="line">(gdb)</div><div class="line">Continuing.</div><div class="line"></div><div class="line">Breakpoint 1, DBC_send_query (self=0x9cf5e40, query=0x4229f160 &quot;close SQL_CUR0x9ec1c20&quot;, qi=0x0, flag=1) at connection.c:3820</div><div class="line">3820		QResultClass *cmdres = NULL,</div><div class="line">(gdb)</div><div class="line">Continuing.</div><div class="line"></div><div class="line">Breakpoint 1, DBC_send_query (self=0x9cf5e40, query=0x9ec1ba0 &quot;declare SQL_CUR0x9ee1240 scroll cursor for SELECT * FROM \&quot;TB1\&quot;&quot;, qi=0x0, flag=0) at connection.c:3820</div><div class="line">3820		QResultClass *cmdres = NULL,</div><div class="line">(gdb)</div><div class="line">Continuing.</div><div class="line"></div><div class="line">Breakpoint 1, DBC_send_query (self=0x9cf5e40, query=0x4229ebc0 &quot;fetch 0 in SQL_CUR0x9ee1240&quot;, qi=0x4229ec50, flag=0) at connection.c:3820</div><div class="line">3820		QResultClass *cmdres = NULL,</div><div class="line">(gdb)</div><div class="line">Continuing.</div><div class="line"></div><div class="line">Breakpoint 1, DBC_send_query (self=0x9cf5e40, query=0x4229cad0 &quot;fetch 1024 in SQL_CUR0x9ee1240&quot;, qi=0x4229cab0, flag=1) at connection.c:3820</div><div class="line">3820		QResultClass *cmdres = NULL,</div><div class="line">(gdb) return 0</div></pre></td></tr></table></figure></p>
<p>接下来就会core掉<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">#0  0x0000003a93e7273e in free () from /lib64/libc.so.6</div><div class="line">#1  0x00002aaade575312 in QR_free_memory (self=0x1b7a17a0) at qresult.c:511</div><div class="line">#2  0x00002aaade574c04 in QR_Destructor (self=0x1b7a17a0, closeCursor=1) at qresult.c:296</div><div class="line">#3  0x00002aaade58d5f2 in STMT_Destructor (self=0x1b7bfe30) at statement.c:507</div><div class="line">#4  0x00002aaade58cec4 in MY_FreeStmt (hstmt=0x1b7bfe30, fOption=1) at statement.c:313</div><div class="line">#5  0x00002aaade59a1ad in SQLFreeHandle (HandleType=3, Handle=0x1b7bfe30) at odbcapi30.c:252</div><div class="line">#6  0x0000003a94e170ed in __SQLFreeHandle (handle_type=&lt;value optimized out&gt;, handle=0x1b7c1650) at SQLFreeHandle.c:435</div><div class="line">#7  0x0000003a94e1768c in SQLFreeHandle (handle_type=17, handle=0x0) at SQLFreeHandle.c:598</div><div class="line">#8  0x0000000000b3591b in FreeQueryHandle (conn=0x1b4117a8) at dblinkutl.c:161</div><div class="line">#9  0x0000000000b36c1c in DBLinkReport (query=0x1b79e8c0, cell=0x1b412348) at dblinkerr.c:68</div><div class="line">#10 0x0000000000b34f5a in dblink_record (fcinfo=0x417853c0) at dblink.c:789</div><div class="line">#11 0x00000000006b3b44 in ExecMakeTableFunctionResult (funcexpr=0x1b79e240, econtext=0x1b79de10, expectedDesc=0x1b79e0d0, returnDesc=0x41785820) at execQual.c:1431</div><div class="line">#12 0x00000000006d055f in FunctionNext (node=0x1b79dcf0) at nodeFunctionscan.c:68</div><div class="line">#13 0x00000000006bd964 in ExecScan (node=0x1b79dcf0, accessMtd=0x6d04f8 &lt;FunctionNext&gt;) at execScan.c:70</div></pre></td></tr></table></figure></p>
<p>那么可以说明我们目前的判断基本正确。出现故障的原因更加清晰了：当时在执行一条pbe语句，在execute阶段通过dblink获取数据时，由于DBC_send_query失败，释放内存不当导致。接下来我们需要找到那块不当释放的内存。</p>
<h2 id="问题根因"><a href="#问题根因" class="headerlink" title="问题根因"></a>问题根因</h2><p>我们找到backend_tuples分配内存的地方：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">self-&gt;backend_tuples = (TupleField *) malloc(self-&gt;num_fields * sizeof(TupleField) * row);</div></pre></td></tr></table></figure></p>
<p>TupleField定义如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">/*› Used by backend data AND manual result sets */</div><div class="line">struct TupleField_</div><div class="line">&#123;</div><div class="line">›   Int4›   ›   len;›   ›   ›   /* length of the current Tuple */</div><div class="line">›   void›      *value;› ›   ›   /* an array representing the value */</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>可见是分配了列数×行数这么大小的空间，可以看作一个表格：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">backend_tuples</div><div class="line">|---------------|---------------|---------------|---------------|</div><div class="line">|tuple[0].len   |tuple[1].len   |tuple[2].len   |tuple[3].len   |</div><div class="line">|tuple[0].value |tuple[1].value |tuple[2].value |tuple[3].value | row1</div><div class="line">|---------------|---------------|---------------|---------------|</div><div class="line">|tuple[0].len   |tuple[1].len   |tuple[2].len   |tuple[3].len   |</div><div class="line">|tuple[0].value |tuple[1].value |tuple[2].value |tuple[3].value | row2</div><div class="line">|---------------|---------------|---------------|---------------|</div><div class="line">.</div><div class="line">.</div><div class="line">.</div></pre></td></tr></table></figure></p>
<p>每个格子都是一个TupleField<br>结合<code>QR_free_memory</code>这个函数来看<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="number">491</span> <span class="keyword">void</span></div><div class="line"><span class="number">492</span> QR_free_memory(QResultClass *self)</div><div class="line"><span class="number">493</span> &#123;</div><div class="line"><span class="number">494</span> ›   <span class="keyword">register</span> <span class="keyword">int</span> lf,</div><div class="line"><span class="number">495</span> ›   ›   ›   ›   row;</div><div class="line"><span class="number">496</span> ›   <span class="keyword">register</span> TupleField *tuple = self-&gt;backend_tuples;</div><div class="line"><span class="number">497</span> ›   SQLLEN› ›   num_backend_rows = self-&gt;num_backend_rows;</div><div class="line"><span class="number">498</span> ›   <span class="keyword">int</span>››   ›   num_fields = self-&gt;num_fields;</div><div class="line"><span class="number">499</span></div><div class="line"><span class="number">500</span> ›   mylog(<span class="string">"QResult: free memory in %x, fcount = %d\n"</span>, self, num_backend_rows);</div><div class="line"><span class="number">501</span> ›   <span class="keyword">if</span> (self-&gt;backend_tuples)</div><div class="line"><span class="number">502</span> ›   &#123;</div><div class="line"><span class="number">503</span> ›   ›   <span class="keyword">for</span> (row = <span class="number">0</span>; row &lt; num_backend_rows; row++)</div><div class="line"><span class="number">504</span> ›   ›   &#123;</div><div class="line"><span class="number">505</span> ›   ›   ›   mylog(<span class="string">"row = %d, num_fields = %d\n"</span>, row, num_fields);</div><div class="line"><span class="number">506</span> ›   ›   ›   <span class="keyword">for</span> (lf = <span class="number">0</span>; lf &lt; num_fields; lf++)</div><div class="line"><span class="number">507</span> ›   ›   ›   &#123;</div><div class="line"><span class="number">508</span> ›   ›   ›   ›   <span class="keyword">if</span> (tuple[lf].value != <span class="literal">NULL</span>)</div><div class="line"><span class="number">509</span> ›   ›   ›   ›   &#123;</div><div class="line"><span class="number">510</span> ›   ›   ›   ›   ›   mylog(<span class="string">"free [lf=%d] %x\n"</span>, lf, tuple[lf].value);</div><div class="line"><span class="number">511</span> ›   ›   ›   ›   ›   <span class="built_in">free</span>(tuple[lf].value);    ---出错行</div><div class="line"><span class="number">512</span> ›   ›   ›   ›   ›   tuple[lf].value = <span class="literal">NULL</span>;</div><div class="line"><span class="number">513</span> ›   ›   ›   ›   &#125;</div><div class="line"><span class="number">514</span> ›   ›   ›   &#125;</div><div class="line"><span class="number">515</span> ›   ›   ›   tuple += num_fields;›   <span class="comment">/* next row */</span></div></pre></td></tr></table></figure></p>
<p>是需要挨个释放 tuple-&gt;value这个指针指向的地址。释放多少个tuple呢？是根据num_backend_rows来判断的。<br>那么就存在如下2个问题：</p>
<ol>
<li>malloc分配的空间，必须置空0，否则tuple.value是一个垃圾值。</li>
<li>num_backend_rows 是否准确？过小则造成内存泄漏，过大则会引起tuple.value指向未知内存。</li>
<li>tuple-&gt;value是否指向有效地址？比如指向已经释放过的地址（释放了必须置NULL），或者无效地址（比如栈空间）。</li>
</ol>
<p>通过看代码，确实存在问题，比如realloc了内存忘记清空，num_backend_rows在读取成功之前就存在递增的情况，如果DBC_send_query失败那么就会有上面第二个问题出现。<br>另外，tuple-&gt;value确实存在指向栈上空间的情况。</p>
<p>查找value指针指向的内存：</p>
<p>1、绝大部分地方value在free之后都置NULL了，但是在TL_Destructor以及STMT_pos_reload_needed函数中，value释放过后没置NULL，可能引起多次释放的问题。</p>
<p>2、在QR_read_tuple函数中，buffer指向的位置是由如下逻辑确定的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">char</span>    tidoidbuf[<span class="number">32</span>];</div><div class="line"><span class="keyword">if</span> (field_lf &gt;= effective_cols)</div><div class="line">      buffer = tidoidbuf;   --buffer指向<span class="built_in">stack</span>位置</div><div class="line"><span class="keyword">else</span></div><div class="line"> &#123;</div><div class="line">    buffer = (<span class="keyword">char</span> *) <span class="built_in">malloc</span>(len + <span class="number">1</span>); --buffer指向heap位置</div><div class="line">    <span class="keyword">if</span>(buffer == <span class="literal">NULL</span>)</div><div class="line">        <span class="keyword">return</span> FALSE;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果满足field_lf &gt;= effective_cols那么是指向stack上的内存，否则是指向heap上的内存。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (field_lf &gt;= effective_cols &amp;&amp; self-&gt;haskeyset)</div><div class="line">&#123;</div><div class="line">           &#125;</div><div class="line"><span class="keyword">else</span></div><div class="line">&#123;</div><div class="line">    this_tuplefield[field_lf].len = len;</div><div class="line">    this_tuplefield[field_lf].value = buffer;   --buffer有可能指向<span class="built_in">stack</span></div><div class="line">          &#125;</div></pre></td></tr></table></figure>
<p>但是如上代码在实际使用过程中，当<code>self-&gt;haskeyset = false</code>的时候，就会返回stack上的内存。</p>
<h2 id="问题修复"><a href="#问题修复" class="headerlink" title="问题修复"></a>问题修复</h2><p>主要是对上面提出的3个问题进行修复：</p>
<ol>
<li>记录malloc,realloc分配内存的范围，检查tuple是否在这个范围之中。</li>
<li>malloc,realloc之后，用memset置空内存，防止垃圾值影响tuple.value。</li>
<li>确保tuple.value不会指向栈上的内存。</li>
</ol>
<p>修复过后，在DBC_send_query失败之后就不会core了，错误正常返回给客户端。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">TEST=# SELECT count(*) from tb1@kdb;</div><div class="line">ERROR:  error in database link &quot;KDB&quot;, SQLSTATE=[HY000] Error fetching next group.</div><div class="line">STATEMENT:  SELECT count(*) from tb1@kdb;</div><div class="line">LOG:  statement: ROLLBACK</div><div class="line">ERROR:  error in database link &quot;KDB&quot;, SQLSTATE=[HY000] Error fetching next group.</div><div class="line">TEST=#</div></pre></td></tr></table></figure></p>
<p>如果还想看到更多此类文章，请移步到<a href="http://shenyu.wiki">小宇的博客</a>。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术分享/">技术分享</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ODBC/">ODBC</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c/">c</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/debug/">debug</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gdb/">gdb</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-a-nice-progressbar-with-time-estimation" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/04/12/a-nice-progressbar-with-time-estimation/" class="article-date">
      <time datetime="2017-04-12T11:51:14.000Z" itemprop="datePublished">2017-04-12</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/12/a-nice-progressbar-with-time-estimation/">a nice progressbar with time estimation</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <blockquote>
<p>Recently I’ve been making a progressbar for database server. I took a full day’s time to carefully implement a linux shell based progressbar which not only can print progress on the terminal but also can estimate the remaining time. </p>
</blockquote>
<p>a screen shot of the progressbar.</p>
<center> <img src="http://static.zybuluo.com/shenyuflying/50vqgj0i2dr4anyg5sdndqx2/main.gif" alt="main.gif-47kB"> </center>

<p>It is implement by C programming language. The source code is below:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;time.h&gt;</span></span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * print a progress bar like this</div><div class="line"> *</div><div class="line"> * LOG:  [========&gt;                    ] 20%  (1h 30m 5s remaining)</div><div class="line"> *</div><div class="line"> * Argument:</div><div class="line"> *      precentage range [0,100]</div><div class="line"> *</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">elog_progress</span><span class="params">(<span class="keyword">int</span> precentage)</span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">char</span>          str[<span class="number">1024</span>]           = &#123;<span class="number">0</span>&#125;; <span class="comment">/* the progress str to print, should be enough */</span></div><div class="line">	<span class="keyword">char</span>         *fmt                 = <span class="string">"LOG:  [%-100s] %3d%%  %s\r"</span>;</div><div class="line">	<span class="keyword">char</span>          bars[<span class="number">100</span>+<span class="number">1</span>]         = &#123;<span class="number">0</span>&#125;;</div><div class="line">	<span class="keyword">int</span>           i;</div><div class="line">	<span class="comment">/* start time will be used the next call, make it static */</span></div><div class="line">	<span class="keyword">static</span> <span class="keyword">time_t</span> start_time          = <span class="number">0</span>;</div><div class="line">	<span class="comment">/* we start estimate after 5 seconds */</span></div><div class="line">	<span class="keyword">const</span>  <span class="keyword">int</span>    estimate_start_time = <span class="number">5</span>;</div><div class="line">	<span class="keyword">char</span>          time_str[<span class="number">1024</span>]      = &#123;<span class="number">0</span>&#125;;</div><div class="line">	<span class="keyword">char</span>         *time_fmt            = <span class="string">"( %dh %2dm %2ds remaining )      "</span>;</div><div class="line">	<span class="keyword">int</span>                             h = <span class="number">0</span>,</div><div class="line">	                                m = <span class="number">0</span>,</div><div class="line">	                                s = <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="comment">/* if not within [0,100], return now */</span></div><div class="line">	<span class="keyword">if</span> (precentage &lt; <span class="number">0</span> || precentage &gt; <span class="number">100</span>)</div><div class="line">		<span class="keyword">return</span>;</div><div class="line"></div><div class="line">	<span class="comment">/* fillin the progress bar */</span></div><div class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; precentage; i++)</div><div class="line">	&#123;</div><div class="line">		bars[i] = <span class="string">'='</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/* fill the head of the progress bar */</span></div><div class="line">	<span class="keyword">if</span> (precentage &gt; <span class="number">0</span> &amp;&amp; precentage &lt; <span class="number">100</span>)</div><div class="line">		bars[precentage] = <span class="string">'&gt;'</span>;</div><div class="line"></div><div class="line">	<span class="comment">/* estimate time */</span></div><div class="line">	<span class="keyword">if</span> (start_time != <span class="number">0</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">time_t</span> time_remaining = <span class="number">0</span>;</div><div class="line">		<span class="keyword">time_t</span> time_cost = <span class="number">0</span>;</div><div class="line">		<span class="comment">/* time cost since start */</span></div><div class="line">		time_cost = time(<span class="literal">NULL</span>) - start_time;</div><div class="line"></div><div class="line">		<span class="comment">/* estimate time remaining */</span></div><div class="line">		<span class="keyword">if</span>(precentage &gt; <span class="number">0</span> &amp;&amp; time_cost &gt;= estimate_start_time)</div><div class="line">		&#123;</div><div class="line">			time_remaining  = time_cost * (<span class="number">100</span> - precentage) / precentage;</div><div class="line">			h = time_remaining/<span class="number">3600</span>;</div><div class="line">			m = time_remaining/<span class="number">60</span>%<span class="number">60</span>;</div><div class="line">			s = time_remaining%<span class="number">60</span>;</div><div class="line">			<span class="built_in">sprintf</span>(time_str, time_fmt, h, m, s);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/* init start time on first run */</span></div><div class="line">	<span class="keyword">if</span> (start_time == <span class="number">0</span>)</div><div class="line">		start_time = time(<span class="literal">NULL</span>);</div><div class="line"></div><div class="line">	<span class="comment">/* ok, we have everything we need , ready to output*/</span></div><div class="line">	<span class="built_in">sprintf</span>(str, fmt, bars, precentage, time_str);</div><div class="line"></div><div class="line">	<span class="built_in">printf</span>(<span class="string">"%s"</span>,str);</div><div class="line">	fflush(<span class="built_in">stdout</span>);</div><div class="line"></div><div class="line">	<span class="comment">/* start a new line when 100% */</span></div><div class="line">	<span class="keyword">if</span> (precentage == <span class="number">100</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"\n"</span>);</div><div class="line">		fflush(<span class="built_in">stdout</span>);</div><div class="line">		<span class="comment">/* reset time estimate */</span></div><div class="line">		start_time = <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> precentage = <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="keyword">while</span>(precentage&lt;=<span class="number">100</span>)</div><div class="line">	&#123;</div><div class="line">		elog_progress(precentage);</div><div class="line">		precentage++;</div><div class="line">		usleep(<span class="number">100000</span>);<span class="comment">/* sleep for 10sec */</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果还想看到更多此类文章，请移步到<a href="http://shenyu.wiki">小宇的博客</a>。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术分享/">技术分享</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c/">c</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-vim-build-from-source" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/04/09/vim-build-from-source/" class="article-date">
      <time datetime="2017-04-09T01:06:12.000Z" itemprop="datePublished">2017-04-09</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/09/vim-build-from-source/">vim build from source</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <blockquote>
<p>the default vim shipped with your system might not have some important features required for some plugins. so you have to build vim from source. here is the steps i took to build vim on my ubuntu based linux plantform.</p>
</blockquote>
<h2 id="prerequisite"><a href="#prerequisite" class="headerlink" title="prerequisite"></a>prerequisite</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install libncurses5-dev libgnome2-dev libgnomeui-dev \</div><div class="line">    libgtk2.0-dev libatk1.0-dev libbonoboui2-dev \</div><div class="line">    libcairo2-dev libx11-dev libxpm-dev libxt-dev python-dev \</div><div class="line">    python3-dev ruby-dev lua5.1 liblua5.1-dev libperl-dev git</div></pre></td></tr></table></figure>
<h2 id="remove-vim-if-you-have-it-already"><a href="#remove-vim-if-you-have-it-already" class="headerlink" title="remove vim if you have it already"></a>remove vim if you have it already</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get remove vim vim-runtime gvim</div></pre></td></tr></table></figure>
<h2 id="configure-amp-amp-make-amp-amp-make-amp-amp-install"><a href="#configure-amp-amp-make-amp-amp-make-amp-amp-install" class="headerlink" title="configure &amp;&amp; make &amp;&amp; make &amp;&amp; install"></a>configure &amp;&amp; make &amp;&amp; make &amp;&amp; install</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">./configure --with-features=huge \</div><div class="line">            --enable-multibyte \</div><div class="line">            --enable-rubyinterp=yes \</div><div class="line">            --enable-pythoninterp=yes \</div><div class="line">            --with-python-config-dir=/usr/lib/python2.7/config \</div><div class="line">            --enable-python3interp=yes \</div><div class="line">            --with-python3-config-dir=/usr/lib/python3.5/config \</div><div class="line">            --enable-perlinterp=yes \</div><div class="line">            --enable-luainterp=yes \</div><div class="line">            --enable-gui=gtk2 --enable-cscope --prefix=/usr</div><div class="line"></div><div class="line">make VIMRUNTIMEDIR=/usr/share/vim/vim80</div><div class="line"></div><div class="line">sudo make install</div></pre></td></tr></table></figure>
<h2 id="update-alternatives"><a href="#update-alternatives" class="headerlink" title="update-alternatives"></a>update-alternatives</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sudo update-alternatives --install /usr/bin/editor editor /usr/bin/vim 1</div><div class="line">sudo update-alternatives --set editor /usr/bin/vim</div><div class="line">sudo update-alternatives --install /usr/bin/vi vi /usr/bin/vim 1</div><div class="line">sudo update-alternatives --set vi /usr/bin/vim</div></pre></td></tr></table></figure>
<h2 id="done"><a href="#done" class="headerlink" title="done"></a>done</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">pi@raspberrypi:~/coding/vim $ vim --version</div><div class="line">VIM - Vi IMproved 8.0 (2016 Sep 12, compiled Apr  8 2017 20:02:05)</div><div class="line">Included patches: 1-550</div><div class="line">Compiled by pi@raspberrypi</div><div class="line">Huge version with GTK2 GUI.  Features included (+) or not (-):</div><div class="line">+acl             +file_in_path    +mouse_sgr       +tag_old_static</div><div class="line">+arabic          +find_in_path    -mouse_sysmouse  -tag_any_white</div><div class="line">+autocmd         +float           +mouse_urxvt     -tcl</div><div class="line">+balloon_eval    +folding         +mouse_xterm     +termguicolors</div><div class="line">+browse          -footer          +multi_byte      +terminfo</div><div class="line">++builtin_terms  +fork()          +multi_lang      +termresponse</div><div class="line">+byte_offset     +gettext         -mzscheme        +textobjects</div><div class="line">+channel         -hangul_input    +netbeans_intg   +timers</div><div class="line">+cindent         +iconv           +num64           +title</div><div class="line">+clientserver    +insert_expand   +packages        +toolbar</div><div class="line">+clipboard       +job             +path_extra      +user_commands</div><div class="line">+cmdline_compl   +jumplist        +perl            +vertsplit</div><div class="line">+cmdline_hist    +keymap          +persistent_undo +virtualedit</div><div class="line">+cmdline_info    +lambda          +postscript      +visual</div><div class="line">+comments        +langmap         +printer         +visualextra</div><div class="line">+conceal         +libcall         +profile         +viminfo</div><div class="line">+cryptv          +linebreak       +python/dyn      +vreplace</div><div class="line">+cscope          +lispindent      +python3/dyn     +wildignore</div><div class="line">+cursorbind      +listcmds        +quickfix        +wildmenu</div><div class="line">+cursorshape     +localmap        +reltime         +windows</div><div class="line">+dialog_con_gui  +lua             +rightleft       +writebackup</div><div class="line">+diff            +menu            +ruby            +X11</div><div class="line">+digraphs        +mksession       +scrollbind      -xfontset</div><div class="line">+dnd             +modify_fname    +signs           +xim</div><div class="line">-ebcdic          +mouse           +smartindent     +xpm</div><div class="line">+emacs_tags      +mouseshape      +startuptime     +xsmp_interact</div><div class="line">+eval            +mouse_dec       +statusline      +xterm_clipboard</div><div class="line">+ex_extra        -mouse_gpm       -sun_workshop    -xterm_save</div><div class="line">+extra_search    -mouse_jsbterm   +syntax</div><div class="line">+farsi           +mouse_netterm   +tag_binary</div><div class="line">   system vimrc file: &quot;$VIM/vimrc&quot;</div><div class="line">     user vimrc file: &quot;$HOME/.vimrc&quot;</div><div class="line"> 2nd user vimrc file: &quot;~/.vim/vimrc&quot;</div><div class="line">      user exrc file: &quot;$HOME/.exrc&quot;</div><div class="line">  system gvimrc file: &quot;$VIM/gvimrc&quot;</div><div class="line">    user gvimrc file: &quot;$HOME/.gvimrc&quot;</div><div class="line">2nd user gvimrc file: &quot;~/.vim/gvimrc&quot;</div><div class="line">       defaults file: &quot;$VIMRUNTIME/defaults.vim&quot;</div><div class="line">    system menu file: &quot;$VIMRUNTIME/menu.vim&quot;</div><div class="line">  fall-back for $VIM: &quot;/usr/share/vim&quot;</div><div class="line"> f-b for $VIMRUNTIME: &quot;/usr/share/vim/vim80&quot;</div><div class="line">Compilation: gcc -c -I. -Iproto -DHAVE_CONFIG_H -DFEAT_GUI_GTK  -pthread -I/usr/include/gtk-2.0 -I/usr/lib/arm-linux-gnueabihf/gtk-2.0/include -I/usr/include/gio-unix-2.0/ -I/usr/include/cairo -I/usr/include/pango-1.0 -I/usr/include/atk-1.0 -I/usr/include/cairo -I/usr/include/pixman-1 -I/usr/include/libpng12 -I/usr/include/gdk-pixbuf-2.0 -I/usr/include/libpng12 -I/usr/include/pango-1.0 -I/usr/include/harfbuzz -I/usr/include/pango-1.0 -I/usr/include/glib-2.0 -I/usr/lib/arm-linux-gnueabihf/glib-2.0/include -I/usr/include/freetype2    -g -O2 -U_FORTIFY_SOURCE -D_FORTIFY_SOURCE=1  </div><div class="line">Linking: gcc   -L. -Wl,-z,relro -L/build/ruby2.1-Fv_iUe/ruby2.1-2.1.5/debian/lib -fstack-protector -rdynamic -Wl,-export-dynamic -Wl,-E   -L/usr/local/lib -Wl,--as-needed -o vim   -lgtk-x11-2.0 -lgdk-x11-2.0 -lpangocairo-1.0 -latk-1.0 -lcairo -lgdk_pixbuf-2.0 -lgio-2.0 -lpangoft2-1.0 -lpango-1.0 -lgobject-2.0 -lglib-2.0 -lfontconfig -lfreetype  -lSM -lICE -lXpm -lXt -lX11 -lXdmcp -lSM -lICE  -lm -ltinfo -lnsl  -lselinux   -ldl  -L/usr/lib -llua5.1 -Wl,-E  -fstack-protector -L/usr/local/lib  -L/usr/lib/arm-linux-gnueabihf/perl/5.20/CORE -lperl -ldl -lm -lpthread -lcrypt    -lruby-2.1 -lpthread -lgmp -ldl -lcrypt -lm</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术分享/">技术分享</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vim/">vim</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-bit-map-sets-sorting" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/04/03/bit-map-sets-sorting/" class="article-date">
      <time datetime="2017-04-03T02:32:06.000Z" itemprop="datePublished">2017-04-03</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/03/bit-map-sets-sorting/">bitmap sets sorting</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
              <blockquote>
<p>BitMapSet can be a very powerful when used for sorting/finding. Because work can be done in O(N) time for sorting and O(1) for finding. Compared to quick sort algorithm, the data is stored in BitMapSet once the data is read into memory. Compared to hash finding, the data is sorted in BitMapSet. In my test, 1,000,000 numbers can be sorted in less than 0.09s on my respberripi and only occupy 125k of memory.</p>
</blockquote>
          
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术分享/">技术分享</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/编程/">编程</a></li></ul>
    </div>

      
        <p class="article-more-link">
          <a href="/2017/04/03/bit-map-sets-sorting/#more">阅读全文 >></a>
        </p>
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-awesome-awesome-lots-of-good-stuff" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/03/26/awesome-awesome-lots-of-good-stuff/" class="article-date">
      <time datetime="2017-03-26T02:32:06.000Z" itemprop="datePublished">2017-03-26</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/26/awesome-awesome-lots-of-good-stuff/">awesome awesome lots of good stuff</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>Awesome awesome is a collection of community maintained lists on a wide range of topics. From front-end development to hardware, from Pokémon to machine learning. It’s a great way to discover and learn new things! Sure you will find something you like!<br>Click the <a href="https://github.com/sindresorhus/awesome" target="_blank" rel="external">link</a> to find out more.</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术分享/">技术分享</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/编程/">编程</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2014-2017 小宇
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit"  title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





    <script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>