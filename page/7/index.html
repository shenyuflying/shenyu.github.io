<!DOCTYPE html>
<html lang="zh-Hans">
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="小宇" />


    
    


<meta name="description" content="Shen Yu">
<meta property="og:type" content="website">
<meta property="og:title" content="小宇的博客">
<meta property="og:url" content="http://shenyu.wiki/page/7/index.html">
<meta property="og:site_name" content="小宇的博客">
<meta property="og:description" content="Shen Yu">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="小宇的博客">
<meta name="twitter:description" content="Shen Yu">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">
<link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css" rel="stylesheet">
<link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">

<!-- for mermaid -->


    <link rel="alternate" href="/atom.xml" title="小宇的博客" type="application/atom+xml">



    <link rel="shortcut icon" href="/uploads/siteicon.png">





    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">



<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>小宇的博客</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: false,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: true
    }
	
</script>


    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/uploads/avatar.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">小宇</a></h1>
        </hgroup>

        
        <p class="header-subtitle">文章：104字数：509965</p>
        

        
            <form id="search-form">
            <input type="text" id="local-search-input" name="q" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off" searchonload="true" />
            <i class="fa fa-times" onclick="resetSearch()"></i>
            </form>
            <div id="local-search-result"></div>
            <p class='no-result'>No results found <i class='fa fa-spinner fa-pulse'></i></p>
        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-home icon-2x">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">归档</a></li>
                        
                            <li><a href="/tags/">标签</a></li>
                        
                            <li><a href="/map/">导航</a></li>
                        
                            <li><a href="/message/">留言</a></li>
                        
                            <li><a href="/about/">关于</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:shenyufly@163.com" title="Email"></a>
                            
                                <a class="fa GitHub" href="http://github.com/shenyuflying" title="GitHub"></a>
                            
                                <a class="fa RSS" href="http://1572339ac8.iok.la:34421" title="RSS"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/DTCC/">DTCC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ECPG/">ECPG</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Greenplum/">Greenplum</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux使用/">Linux使用</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux编程/">Linux编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OCI/">OCI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ODBC/">ODBC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Oracle/">Oracle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PLSQL/">PLSQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PostgreSQL/">PostgreSQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PostgreSQL使用/">PostgreSQL使用</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PostgreSQL内核/">PostgreSQL内核</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PostgreSQL接口/">PostgreSQL接口</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shell/">Shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/algorithm/">algorithm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/assembly/">assembly</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/">c</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cctree/">cctree</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cflow/">cflow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/codeviz/">codeviz</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/debug/">debug</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dns/">dns</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dnsmasq/">dnsmasq</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/doxygen/">doxygen</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/egypt/">egypt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/events/">events</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gdb/">gdb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/">golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gprof/">gprof</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kcachegrind/">kcachegrind</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mathjax/">mathjax</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nas/">nas</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nextcloud/">nextcloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pgxc/">pgxc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/programming/">programming</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sed/">sed</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/">shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/valgrind/">valgrind</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vim/">vim</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wget/">wget</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/基础知识/">基础知识</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/备份还原/">备份还原</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/小宇带你学PostgreSQL内核/">小宇带你学PostgreSQL内核</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/工具/">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/开源社区/">开源社区</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/技术分享/">技术分享</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/接口/">接口</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/操作系统/">操作系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据库/">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据库，PostgreSQL/">数据库，PostgreSQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据结构与算法/">数据结构与算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/文章/">文章</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/旅行/">旅行</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/本地化/">本地化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/架构/">架构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/查询优化/">查询优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/树莓派/">树莓派</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/汇编调试方法/">汇编调试方法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/爱好/">爱好</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/编程/">编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/编程语言/">编程语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网站/">网站</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/语言层/">语言层</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/读书/">读书</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/调优/">调优</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://pages.github.com/">GitHub</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://moxfive.xyz/">MOxFIVE</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">专注于基础软件研发</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">小宇</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/uploads/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">小宇</a></h1>
            </hgroup>
            
            <p class="header-subtitle">文章：104字数：509965</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">归档</a></li>
                
                    <li><a href="/tags/">标签</a></li>
                
                    <li><a href="/map/">导航</a></li>
                
                    <li><a href="/message/">留言</a></li>
                
                    <li><a href="/about/">关于</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:shenyufly@163.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="http://github.com/shenyuflying" title="GitHub"></a>
                            
                                <a class="fa RSS" target="_blank" href="http://1572339ac8.iok.la:34421" title="RSS"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap">
  
    <article id="post-C语言程序的国际化" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/11/02/C语言程序的国际化/" class="article-date">
      <time datetime="2016-11-02T03:37:12.000Z" itemprop="datePublished">2016-11-02</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/02/C语言程序的国际化/">C语言程序的国际化</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <blockquote>
<p>c语言程序写的时候字符串用英语，基本固定了。那么如果想让别的语言的人使用（比如中文），就得把程序里面的字符串挨个翻译，最后再重新编译一次程序维护起来特别麻烦。那么有什么办法能够让程序显示中文？GNU的gettext项目就是用来做这个的。这篇文章以c语言为例介绍了国际化的gettext。</p>
</blockquote>
<h2 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h2><p>.po文件： po，Portable Object，里面记录了翻译内容。<br>.mo文件： mo，Machine Object，其实是一个二进制文件，用来提供给程序使用。<br>xgettext：一个工具，根据c文件生成po文件<br>msgfmt： 一个工具，根据po文件生成mo文件<br>msgmerge：更新po文件</p>
<h2 id="基本过程"><a href="#基本过程" class="headerlink" title="基本过程"></a>基本过程</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">        xgettext              翻译        msgfmt          INSTALL</div><div class="line">.c文件-----------&gt;.pot文件----------&gt;.po----------&gt;.mo------------&gt;./bin/po/zh/LC_MESSAGES/.mo</div><div class="line"></div><div class="line">         gcc                              INSTALL</div><div class="line">.c文件-----------&gt;可执行文件--------------------------------------&gt;./bin</div></pre></td></tr></table></figure>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>在程序中添加这么几行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">#include &lt;libintl.h&gt;</div><div class="line">#include&lt;locale.h&gt;</div><div class="line">#define _(String) gettext (String)</div><div class="line">#define gettext_noop(String) String</div><div class="line">#define N_(String) gettext_noop (String)</div><div class="line"></div><div class="line">int main()</div><div class="line">&#123;</div><div class="line">...</div><div class="line">    setlocale (LC_ALL, &quot;&quot;);</div><div class="line">    bindtextdomain (PACKAGE, LOCALEDIR);</div><div class="line">    textdomain (PACKAGE);</div><div class="line">...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在需要翻译的字符串使用<code>_()</code>包括进来。比如如下的一个例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">#include&lt;stdio.h&gt;                                                               </div><div class="line">#include&lt;stdlib.h&gt;</div><div class="line">#include&lt;locale.h&gt;</div><div class="line">#include &lt;libintl.h&gt;</div><div class="line">#define _(String) gettext (String)</div><div class="line">#define gettext_noop(String) String</div><div class="line">#define N_(String) gettext_noop (String)</div><div class="line"></div><div class="line">#define PACKAGE &quot;main&quot;</div><div class="line">#define LOCALEDIR &quot;po&quot;</div><div class="line"></div><div class="line">int main(int argc, char *argv[])</div><div class="line">&#123;</div><div class="line">    setlocale (LC_ALL, &quot;&quot;);</div><div class="line">    bindtextdomain (PACKAGE, LOCALEDIR);</div><div class="line">    textdomain (PACKAGE);</div><div class="line">    printf(_(&quot;Hello world!\n&quot;));</div><div class="line"></div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>用xgettext程序来从.c文件中找到所有可以翻译的字符串并生成.pot模板文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">xgettext -k_ -o main.pot main.c </div><div class="line">cp main.pot main.po</div></pre></td></tr></table></figure></p>
<p>翻译po文件中的字符串，po文件的格式详见<a href="http://www.gnu.org/software/gettext/manual/html_node/PO-Files.html#PO-Files" target="_blank" rel="external">http://www.gnu.org/software/gettext/manual/html_node/PO-Files.html#PO-Files</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"># SOME DESCRIPTIVE TITLE.                                                       </div><div class="line"># Copyright (C) YEAR THE PACKAGE&apos;S COPYRIGHT HOLDER</div><div class="line"># This file is distributed under the same license as the PACKAGE package.</div><div class="line"># FIRST AUTHOR &lt;EMAIL@ADDRESS&gt;, YEAR.</div><div class="line">#</div><div class="line">#, fuzzy</div><div class="line">msgid &quot;&quot;</div><div class="line">msgstr &quot;&quot;</div><div class="line">&quot;Project-Id-Version: PACKAGE VERSION\n&quot;</div><div class="line">&quot;Report-Msgid-Bugs-To: \n&quot;</div><div class="line">&quot;POT-Creation-Date: 2016-11-02 17:31+0800\n&quot;</div><div class="line">&quot;PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n&quot;</div><div class="line">&quot;Last-Translator: FULL NAME &lt;EMAIL@ADDRESS&gt;\n&quot;</div><div class="line">&quot;Language-Team: LANGUAGE &lt;LL@li.org&gt;\n&quot;</div><div class="line">&quot;Language: \n&quot;</div><div class="line">&quot;MIME-Version: 1.0\n&quot;</div><div class="line">&quot;Content-Type: text/plain; charset=UTF-8\n&quot;</div><div class="line">&quot;Content-Transfer-Encoding: 8bit\n&quot;</div><div class="line"></div><div class="line">#: main.c:18</div><div class="line">#, c-format</div><div class="line">msgid &quot;Hello world!\n&quot;</div><div class="line">msgstr &quot;你好世界！\n&quot;</div></pre></td></tr></table></figure></p>
<p>用msgfmt从po文件生成mo文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ msgfmt ./main.po -o main.mo</div></pre></td></tr></table></figure>
<p>把mo文件放到正确的地方，注意这里的<code>po</code>文件夹是main.c里面<code>PACKAGE</code>对应的文件夹。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ mkdir -p po/zh_CN/LC_MESSAGES/</div><div class="line">$ cp ./main.mo  ./po/zh_CN/LC_MESSAGES/main.mo</div></pre></td></tr></table></figure></p>
<p>接下来要gcc编译这个程序。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gcc main.c -o main</div></pre></td></tr></table></figure></p>
<p>最后是这样的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$ tree</div><div class="line">.</div><div class="line">├── main</div><div class="line">├── main.c</div><div class="line">├── main.mo</div><div class="line">├── main.po</div><div class="line">├── main.pot</div><div class="line">└── po</div><div class="line">    └── zh_CN</div><div class="line">        └── LC_MESSAGES</div><div class="line">            └── main.mo</div><div class="line"></div><div class="line">3 directories, 6 files</div></pre></td></tr></table></figure></p>
<p>运行一下，看到已经是翻译成中文了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ ./main </div><div class="line">你好世界！</div></pre></td></tr></table></figure></p>
<h2 id="维护"><a href="#维护" class="headerlink" title="维护"></a>维护</h2><p>如果以后修改了.c文件，比如新加了一行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">    printf(_(&quot;Hello world!\n&quot;));</div><div class="line">    printf(_(&quot;Hello again!\n&quot;));</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>那么用msgmerge就可以更新原来的po文件，不需要再从头来过<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">$ xgettext --add-comments --keyword=_ main.c -o main.pot --from-code=UTF-8</div><div class="line">$ mv main.pot main.po</div><div class="line">$ msgmerge main.po.old main.po</div><div class="line">main.po: 警告： 字符集“CHARSET”不是可移植的编码名称。</div><div class="line">                将消息转换为用户字符集可能不工作。</div><div class="line">.... 完成。</div><div class="line"># SOME DESCRIPTIVE TITLE.</div><div class="line"># Copyright (C) YEAR THE PACKAGE&apos;S COPYRIGHT HOLDER</div><div class="line"># This file is distributed under the same license as the PACKAGE package.</div><div class="line"># FIRST AUTHOR &lt;EMAIL@ADDRESS&gt;, YEAR.</div><div class="line">#</div><div class="line">#, fuzzy</div><div class="line">msgid &quot;&quot;</div><div class="line">msgstr &quot;&quot;</div><div class="line">&quot;Project-Id-Version: PACKAGE VERSION\n&quot;</div><div class="line">&quot;Report-Msgid-Bugs-To: \n&quot;</div><div class="line">&quot;POT-Creation-Date: 2016-11-02 18:30+0800\n&quot;</div><div class="line">&quot;PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n&quot;</div><div class="line">&quot;Last-Translator: FULL NAME &lt;EMAIL@ADDRESS&gt;\n&quot;</div><div class="line">&quot;Language-Team: LANGUAGE &lt;LL@li.org&gt;\n&quot;</div><div class="line">&quot;Language: \n&quot;</div><div class="line">&quot;MIME-Version: 1.0\n&quot;</div><div class="line">&quot;Content-Type: text/plain; charset=UTF-8\n&quot;</div><div class="line">&quot;Content-Transfer-Encoding: 8bit\n&quot;</div><div class="line"></div><div class="line">#: main.c:18</div><div class="line">#, c-format</div><div class="line">msgid &quot;Hello world!\n&quot;</div><div class="line">msgstr &quot;你好世界！\n&quot;</div><div class="line"></div><div class="line">#: main.c:19</div><div class="line">#, fuzzy, c-format</div><div class="line">msgid &quot;Hello again!\n&quot;</div><div class="line">msgstr &quot;你好世界！\n&quot;</div></pre></td></tr></table></figure></p>
<p>可以看到Hello again被翻译成了你好世界，上面注释有fuzzy是标示这个翻译是模糊匹配的，需要人工再翻译一下。翻译过后去掉fuzzy即可。弄完之后用msgfmt再生成mo文件并拷贝到指定目录即可。当然这些都可以用Makefile来维护。稍后再写一篇PostgreSQL国际化的内容。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术分享/">技术分享</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c/">c</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/编程/">编程</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-x86-64汇编与调试" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/10/29/x86-64汇编与调试/" class="article-date">
      <time datetime="2016-10-28T23:24:09.000Z" itemprop="datePublished">2016-10-29</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/29/x86-64汇编与调试/">x86_64汇编与调试</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
              <blockquote>
<p>汇编调试如下好处：<br>1）调试Release版本，调试对象里面没有debug符号。<br>2）当C代码一行中执行了很多语句，汇编调试可以准确定位错误的情况。<br>3）可以分析栈溢出等复杂的错误。<br>掌握汇编和反汇编，会更加清楚寄存器，内存，汇编指令，程序堆栈等概念，理解C语言运行时的细节，帮助提高编程能力。</p>
</blockquote>
<h1 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h1><p><img src="http://static.zybuluo.com/shenyuflying/r7omgxk97tbzi0axk0pd211a/image_1b07j5oorei6i04o1e1usj1b0d9.png" alt="计算机结构"></p>
          
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术分享/">技术分享</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/assembly/">assembly</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gdb/">gdb</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/工具/">工具</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/编程语言/">编程语言</a></li></ul>
    </div>

      
        <p class="article-more-link">
          <a href="/2016/10/29/x86-64汇编与调试/#more">阅读全文 >></a>
        </p>
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-golang-web编程之——读取csdn最新文章" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/10/29/golang-web编程之——读取csdn最新文章/" class="article-date">
      <time datetime="2016-10-28T22:35:08.000Z" itemprop="datePublished">2016-10-29</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/29/golang-web编程之——读取csdn最新文章/">golang web编程之——读取csdn最新文章</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <blockquote>
<p>利用go语言内置的各种网络包可以方便的进行web编程。本文章利用了csdn的<a href="http://open.csdn.net/wiki/apis" target="_blank" rel="external">开放API</a>实现读取最新文章的需求。演示了go语言发起http get请求和json的umarshing特性。</p>
</blockquote>
<h2 id="简单的http-GET请求"><a href="#简单的http-GET请求" class="headerlink" title="简单的http GET请求"></a>简单的http GET请求</h2><p>go语言内置了<code>net/http</code>包，采用<code>http.Get</code>能够方便的发起GET请求</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"io/ioutil"</span></div><div class="line">	<span class="string">"log"</span></div><div class="line">	<span class="string">"net/http"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line"></div><div class="line">	resp, err := http.Get(<span class="string">"http://api.csdn.net/blog/getnewarticlelist?client_id=????&amp;page=1&amp;size=10"</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatal(err)</div><div class="line">	&#125;</div><div class="line">	contents, err := ioutil.ReadAll(resp.Body)</div><div class="line">	resp.Body.Close()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatal(err)</div><div class="line">	&#125;</div><div class="line">	fmt.Printf(<span class="string">"%s"</span>, contents)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看到返回的内容为json格式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&quot;page&quot;:1,&quot;count&quot;:12733,&quot;size&quot;:10,&quot;list&quot;:[&#123;&quot;ArticleId&quot;:52963517,&quot;BlogId&quot;:5022393,&quot;UserName&quot;:&quot;u013410747&quot;,&quot;Title&quot;:&quot;linux修改默认的编辑器&quot;,&quot;Description&quot;:&quot;sudo select-editor    选择vim 搞定。。&quot;,&quot;PostTime&quot;:&quot;\/Date(1477712141000)\/&quot;,&quot;UpdateTime&quot;:&quot;\/Date(1477712177908)\/&quot;,&quot;Digg&quot;:0,&quot;Bury&quot;:0,&quot;ChannelId&quot;:2,&quot;Type&quot;:1,&quot;Status&quot;:0,&quot;ViewCount&quot;:0,&quot;CommentCount&quot;:0,&quot;CommentAuth&quot;:2,&quot;IsTop&quot;:false,&quot;Level&quot;:0,&quot;OutlinkCount&quot;:0,&quot;Note&quot;:null,&quot;IP&quot;:null,&quot;Categories&quot;:null,&quot;Tags&quot;:[],&quot;ColumnAlias&quot;:null,&quot;ColumnTitle&quot;:null,&quot;MarkDownContent&quot;:null,&quot;MarkDownDirectory&quot;:null,&quot;ArticleEditType&quot;:0,&quot;ArticleMore&quot;:null&#125;,...umnAlias&quot;:null,&quot;ColumnTitle&quot;:null,&quot;MarkDownContent&quot;:null,&quot;MarkDownDirectory&quot;:null,&quot;ArticleEditType&quot;:0,&quot;ArticleMore&quot;:null&#125;]&#125;成功: 进程退出代码 0.</div></pre></td></tr></table></figure>
<h2 id="JSON转为内部结构体"><a href="#JSON转为内部结构体" class="headerlink" title="JSON转为内部结构体"></a>JSON转为内部结构体</h2><p>那么如何把json格式的内容转为golang的内部结构体呢？这需要利用<code>json.Unmarshal</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"encoding/json"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"io/ioutil"</span></div><div class="line">	<span class="string">"log"</span></div><div class="line">	<span class="string">"net/http"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> Article <span class="keyword">struct</span> &#123;</div><div class="line">	ArticleId   <span class="keyword">int</span></div><div class="line">	BlogId      <span class="keyword">int</span></div><div class="line">	UserName    <span class="keyword">string</span></div><div class="line">	Title       <span class="keyword">string</span></div><div class="line">	Description <span class="keyword">string</span></div><div class="line">	PostTime    <span class="keyword">string</span></div><div class="line">	UpdateTime  <span class="keyword">string</span></div><div class="line">	ViewCount    <span class="keyword">int</span></div><div class="line">	CommentCount <span class="keyword">int</span></div><div class="line">	Categories  <span class="keyword">int</span></div><div class="line">	ColumnAlias <span class="keyword">bool</span></div><div class="line">	Url         <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">type</span> Articles <span class="keyword">struct</span> &#123;</div><div class="line">	Page  <span class="keyword">int</span> <span class="string">`json:"page,int"`</span></div><div class="line">	Count <span class="keyword">int</span></div><div class="line">	Size  <span class="keyword">int</span></div><div class="line">	List  []*Article</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	resp, err := http.Get(<span class="string">"http://api.csdn.net/blog/getnewarticlelist?client_id=????&amp;page=0&amp;size=20"</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatal(err)</div><div class="line">	&#125;</div><div class="line">	str, err := ioutil.ReadAll(resp.Body)</div><div class="line">	resp.Body.Close()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatal(err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> contents Articles</div><div class="line">	<span class="keyword">if</span> err := json.Unmarshal(str, &amp;contents); err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatal(<span class="string">"Json unmarshing failed: "</span>, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> k, v := <span class="keyword">range</span> contents.List &#123;</div><div class="line">		fmt.Printf(<span class="string">"%v. %v\n"</span>, k, v.Title)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后，我们完成了用csdn的<a href="http://open.csdn.net/wiki/apis" target="_blank" rel="external">开放API</a>实现读取最新文章的需求。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">0. 1048. Find Coins (25)解题报告</div><div class="line">1. 1049. Counting Ones (30)解题报告</div><div class="line">2. java实习第二天</div><div class="line">3. 1060. 爱丁顿数(25)</div><div class="line">4. 剑指offer-数组中出现次数超过一半的数字</div><div class="line">5. jsonp跨域访问案例</div><div class="line">6. framework jar包MAKEFILE示例</div><div class="line">7. Unity3d 乱序之惑</div><div class="line">8. CodeForces 445C DZY Loves Physics</div><div class="line">9. LeetCode #424: Longest Repeating Character Replacement</div><div class="line">10. 面板显示private变量用标签[SerializeField]</div><div class="line">11. PostgreSQL问题解决--连接数过多</div><div class="line">12. 多维高斯分布及多维条件高斯分布</div><div class="line">13. 王朝  都要学C</div><div class="line">14. CharacterController.Move 实现角色移动</div><div class="line">15. bootargs</div><div class="line">16. 不用输入法输自己的名字!!!!</div><div class="line">17. mybatis mbg自动生成的selectByExample按条件查询不出来值。</div><div class="line">18. 系统乔迁留念贴</div><div class="line">19. java中Proxy(代理与动态代理)</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术分享/">技术分享</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/golang/">golang</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/编程语言/">编程语言</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-PostgreSQL中的字符编码" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/10/27/PostgreSQL中的字符编码/" class="article-date">
      <time datetime="2016-10-27T04:02:21.000Z" itemprop="datePublished">2016-10-27</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/27/PostgreSQL中的字符编码/">PostgreSQL中的字符编码</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>字符编码（Character encoding）就是把某种或多种字符（比如英语字母，中文）按照某种形式编码为比特，以便于在计算机中存储和通过网络进行传递。常见的字符编码有ASCII、UTF-8、GBK等等。</p>
<p>PostgreSQL支持多种编码字符集，对各种语言有很好的支持。每个数据库有一个字符集，字符集在初始化数据库<code>initdb -E UTF-8</code>或新建数据库<code>CREATE DATABASE chinese WITH ENCODING &#39;UTF-8&#39;</code>时确定。编码信息保存在系统表<code>pg_database</code>中。你可以在psql中用-l命令来查看数据库和对应的字符集编码。</p>
<p>服务器端不是对所有编码都支持，比如不支持GBK，但是PostgreSQL支持服务器发给客户端时自动转码，比如可以转码为GBK。转码规则在系统表<code>pg_conversion</code>里确定。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">postgres=# select  conname, conproc from pg_conversion where conname like &apos;%gbk%&apos;;</div><div class="line">   conname   |   conproc   </div><div class="line">-------------+-------------</div><div class="line"> gbk_to_utf8 | gbk_to_utf8</div><div class="line"> utf8_to_gbk | utf8_to_gbk</div><div class="line">(2 rows)</div></pre></td></tr></table></figure></p>
<p>比如如下例子，服务器的默认编码是UTF8<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">postgres=# \l</div><div class="line">                               List of databases</div><div class="line">    Name    | Owner | Encoding |   Collate   |    Ctype    | Access privileges </div><div class="line">------------+-------+----------+-------------+-------------+-------------------</div><div class="line"> postgres   | yshen | UTF8     | zh_CN.UTF-8 | zh_CN.UTF-8 |</div></pre></td></tr></table></figure></p>
<p>客户端的通过<code>set client_encoding = GBK;</code>设为GBK<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">postgres=# set client_encoding = GBK;</div><div class="line">SET</div><div class="line">postgres=# show client_encoding ;</div><div class="line"> client_encoding </div><div class="line">-----------------</div><div class="line"> GBK</div><div class="line">(1 row)</div></pre></td></tr></table></figure></p>
<p>在查询过程中，服务器把UTF8编码转换为GBK发送到客户端<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">postgres=# select * from student;</div><div class="line">   sno   | sname  | gender | age | nation | classno </div><div class="line">---------+--------+--------+-----+--------+---------</div><div class="line"> 2016001 | 王二小 | 男     |  20 | 中国   | 1-1</div><div class="line"> 2016002 | 刘胡兰 | 女     |  20 | 中国   | 1-1</div><div class="line"> 2016003 | 李小明 | 男     |  20 | 中国   | 1-2</div><div class="line"> 2016004 | 李小花 | 女     |  20 | 中国   | 1-2</div><div class="line">(4 rows)</div></pre></td></tr></table></figure></p>
<p>那么编码是如何在内部实现的呢？窥探一下内部函数<code>utf8_to_gbk</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">Datum</div><div class="line">utf8_to_gbk(PG_FUNCTION_ARGS)</div><div class="line">&#123;</div><div class="line">	unsigned char *src = (unsigned char *) PG_GETARG_CSTRING(2);</div><div class="line">	unsigned char *dest = (unsigned char *) PG_GETARG_CSTRING(3);</div><div class="line">	int			len = PG_GETARG_INT32(4);</div><div class="line"></div><div class="line">	CHECK_ENCODING_CONVERSION_ARGS(PG_UTF8, PG_GBK);</div><div class="line"></div><div class="line">	UtfToLocal(src, len, dest,</div><div class="line">			   ULmapGBK, lengthof(ULmapGBK),</div><div class="line">			   NULL, 0,</div><div class="line">			   NULL,</div><div class="line">			   PG_GBK);</div><div class="line"></div><div class="line">	PG_RETURN_VOID();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其实就是根据输入的字节流寻找一种编码到另一种编码的映射关系，映射关系保存在ULmapGBK这个里面,找到映射关系之后再把另一种编码对应的字节输出。</p>
<p>有兴趣可以移步<a href="https://www.postgresql.org/docs/9.5/static/multibyte.html" target="_blank" rel="external">官方手册</a>进一步了解</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术分享/">技术分享</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PostgreSQL/">PostgreSQL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PostgreSQL使用/">PostgreSQL使用</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/数据库/">数据库</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-linux中的本地化" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/10/27/linux中的本地化/" class="article-date">
      <time datetime="2016-10-27T02:03:21.000Z" itemprop="datePublished">2016-10-27</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/27/linux中的本地化/">linux中的本地化</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <blockquote>
<p>linux中显示乱码了怎么办？这时候需要设置对本地化。知其然还要知其所以然，下面一步步来为你截开linux中的本地化的神秘面纱。</p>
</blockquote>
<h2 id="从locale说起"><a href="#从locale说起" class="headerlink" title="从locale说起"></a>从locale说起</h2><p>locale翻译过来是<code>本地</code>的意思。linux中的<code>locale</code>工具能够输出当前本地化信息，或者输出所有支持的本地化、编码信息。<br>在linux中执行<code>locale</code>命令可以显示出当前的本地化信息。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">$ locale</div><div class="line">LANG=zh_CN.UTF-8</div><div class="line">LANGUAGE=zh_CN:zh</div><div class="line">LC_CTYPE=&quot;zh_CN.UTF-8&quot;</div><div class="line">LC_NUMERIC=&quot;zh_CN.UTF-8&quot;</div><div class="line">LC_TIME=&quot;zh_CN.UTF-8&quot;</div><div class="line">LC_COLLATE=&quot;zh_CN.UTF-8&quot;</div><div class="line">LC_MONETARY=&quot;zh_CN.UTF-8&quot;</div><div class="line">LC_MESSAGES=&quot;zh_CN.UTF-8&quot;</div><div class="line">LC_PAPER=&quot;zh_CN.UTF-8&quot;</div><div class="line">LC_NAME=&quot;zh_CN.UTF-8&quot;</div><div class="line">LC_ADDRESS=&quot;zh_CN.UTF-8&quot;</div><div class="line">LC_TELEPHONE=&quot;zh_CN.UTF-8&quot;</div><div class="line">LC_MEASUREMENT=&quot;zh_CN.UTF-8&quot;</div><div class="line">LC_IDENTIFICATION=&quot;zh_CN.UTF-8&quot;</div><div class="line">LC_ALL=</div></pre></td></tr></table></figure></p>
<p>本地化信息包含了13个变量</p>
<ol>
<li>LC_CTYPE<br>用于字符分类和字符串处理（大小写转换），控制所有字符的处理方式，包括字符编码，字符是单字节还是多字节，如何打印等。是最重要的一个环境变量。</li>
<li>LC_COLLATE<br>字符的比较和排序规则。</li>
<li>LC_MONETARY<br>货币格式。</li>
<li>LC_NUMERIC<br>非货币的数字显示格式。</li>
<li>LC_TIME<br>时间和日期格式。</li>
<li>LC_MESSAGES<br>提示信息的语言。另外还有一个LANGUAGE参数，它与LC_MESSAGES相似，但如果该参数一旦设置，则LC_MESSAGES参数就会失效。LANGUAGE参数可同时设置多种语言信息，如LANGUANE=”zh_CN.GB18030:zh_CN.GB2312:zh_CN”。</li>
<li>LANG<br>LC<em>*的默认值，是最低级别的设置，如果LC</em>*没有设置，则使用该值。类似于 LC_ALL。如果LANG设置了，别的变量也设置成这个值。</li>
<li>LC<em>ALL<br>它是一个宏，如果该值设置了，则该值会覆盖所有LC</em>*的设置值。注意，LANG的值不受该宏影响。</li>
<li>LC_PAPER<br>纸张大小。</li>
<li>LC_NAME<br>名称的格式</li>
<li>LC_ADDRESS<br>地址的格式</li>
<li>LC_TELEPHONE<br>电话的格式</li>
<li>LC_MEASUREMENT<br>度量单位</li>
</ol>
<p>可以看各种变量的值都是<code>zh_CN.UTF-8</code>,它表示什么意思呢？<br>分为2个部分:<br><code>zh_CN</code> : 是语言.地点信息<br><code>UTF-8</code> : 是字符编码信息<br>其书写格式是<code>语言[_地域[.字符集]]</code><br>比如<code>zh_CN.UTF-8</code>说明现在用中文，地处中华人民共和国，用的是UTF-8字符编码。<br>比如<code>zh_TW.BIG5</code>说名现在用中文，地处台湾，用的是大五码字符集<br>可以通过<code>locale -a</code>命令查看支持的地点<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ locale -a</div><div class="line">C           #最早期简单的C语言环境</div><div class="line">C.UTF-8</div><div class="line">en_US.utf8  #美国</div><div class="line">POSIX       #posix标准</div><div class="line">zh_CN.utf8  #中国</div><div class="line">zh_SG.utf8  #新加坡</div></pre></td></tr></table></figure></p>
<p>可以通过<code>locale -m</code>命令查看支持的编码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ locale -m | grep BIG</div><div class="line">BIG5</div><div class="line">BIG5-HKSCS</div><div class="line">UTF-8</div><div class="line">GB18030</div><div class="line">GB2312</div><div class="line">GBK</div><div class="line">GB_1988-80</div></pre></td></tr></table></figure></p>
<p>有关这些信息都放在<code>/usr/share/i18n</code>文件夹下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">/usr/share/i18n</div><div class="line">|-- SUPPORTED</div><div class="line">|-- charmaps</div><div class="line">|   |-- ANSI_X3.110-1983.gz</div><div class="line">|   |-- ANSI_X3.4-1968.gz</div><div class="line">|   |-- ARMSCII-8.gz</div><div class="line">|   |-- ASMO_449.gz</div><div class="line">|   |-- BIG5-HKSCS.gz</div><div class="line">|   |-- BIG5.gz</div><div class="line">|   |-- UTF-8.gz</div><div class="line">|   |-- VIDEOTEX-SUPPL.gz</div><div class="line">|   |-- VISCII.gz</div><div class="line">|   `-- WINDOWS-31J.gz</div><div class="line">`-- locales</div><div class="line">    |-- POSIX</div><div class="line">    |-- aa_DJ</div><div class="line">    |-- aa_ER</div><div class="line">    |-- aa_ER@saaho</div><div class="line">    |-- aa_ET</div><div class="line">    |-- af_ZA</div><div class="line">    |-- zh_CN</div><div class="line">    |-- zh_HK</div><div class="line">    |-- zh_SG</div><div class="line">    |-- zh_TW</div><div class="line">    `-- zu_ZA</div></pre></td></tr></table></figure></p>
<p>locales文件夹下面其实都是可编辑的文本文件。有兴趣的可以打开试试。</p>
<p>有时候因为编码的不同，显示出来的是乱码。那么如何设置呢？</p>
<h2 id="如何设置编码"><a href="#如何设置编码" class="headerlink" title="如何设置编码"></a>如何设置编码</h2><p>设定locale就是设定12大类的locale分类属性，即13个<code>LC_*</code>。除了这13个变量可以设定以外，为了简便起见，还有两个变量：<code>LC_ALL</code>和<code>LANG</code>。它们之间有一个优先级的关系：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">LC_ALL &gt; LANG</div></pre></td></tr></table></figure></p>
<p>可以这么说，LC_ALL是最上级设定或者强制设定，而LANG是默认设定值。</p>
<p>1、如果你设定了<code>LC_ALL＝zh_CN.UTF-8</code>，那么不管<code>LC_*</code>和<code>LANG</code>设定成什么值，它们都会被强制服从<code>LC_ALL</code>的设定，成为 <code>zh_CN.UTF-8</code>。</p>
<p>2、假如你设定了<code>LANG＝zh_CN.UTF-8</code>，并且没有设定<code>LC_ALL</code>的话，那么系统的locale设定以<code>LC_*=zh_CN.UTF-8</code>。</p>
<p>PS: 除了环境变量设置对，如果使用的是图形化终端，还需要在终端设置相应的编码。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术分享/">技术分享</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux编程/">Linux编程</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c/">c</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/操作系统/">操作系统</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-交互式代码格式化工具——indent" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/10/21/交互式代码格式化工具——indent/" class="article-date">
      <time datetime="2016-10-21T01:20:49.000Z" itemprop="datePublished">2016-10-21</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/21/交互式代码格式化工具——indent/">交互式代码格式化工具——indent</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <blockquote>
<p>有时候在编码过程中很多细节不注意，造成了代码不符合规范。如果人工来检查，比较繁琐，还容易遗漏，不如交给工具做。在之前一片文章<a href="http://shenyu.wiki/2016/10/20/%E5%88%A9%E7%94%A8sed%E7%94%9F%E6%88%90%E8%A7%84%E8%8C%83%E7%9A%84c%E4%BB%A3%E7%A0%81/">《利用sed生成规范的c代码 》</a>基础上集合shell+vimdiff实现了交互式代码检查。</p>
</blockquote>
<h2 id="先睹为快"><a href="#先睹为快" class="headerlink" title="先睹为快"></a>先睹为快</h2><p>一份不规范的代码test.c运行工具检查一下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./indent test.c</div></pre></td></tr></table></figure></p>
<p>效果如下图所示：<br><img src="http://static.zybuluo.com/shenyuflying/qv3omp4cp2ycm123vqscxob5/image_1avj8a4sm1fvr2s1e9dgsjrgs9.png" alt=""></p>
<p>左面是例子中的那份不规范的代码，右面是提示的规范代码。不规范的代码用红色标出。如果接受修改，移动到红色处用do来接受修改。]c移动到下一处。</p>
<p>修改完了之后wqa退出。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>这个小工具是用shell+sed+vimdiff写的。可以看到linux的强大之处就是可以融合多个工具来实现一个更强大的工具。<br>源码放在了github上：<a href="https://github.com/shenyuflying/indent" target="_blank" rel="external">https://github.com/shenyuflying/indent</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术分享/">技术分享</a><a class="article-category-link" href="/categories/技术分享/开源社区/">开源社区</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Shell/">Shell</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/编程语言/">编程语言</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-利用sed生成规范的c代码" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/10/20/利用sed生成规范的c代码/" class="article-date">
      <time datetime="2016-10-20T02:15:38.000Z" itemprop="datePublished">2016-10-20</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/20/利用sed生成规范的c代码/">利用sed生成规范的c代码</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <blockquote>
<p>有时候在编码过程中很多细节不注意，造成了代码不符合规范。一行行人工来修改，太麻烦了，不如交给工具做。鼎鼎大名的sed就是用来帮助你做这些繁重工作的。</p>
</blockquote>
<p>我们准备了一个不规范的代码<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$ cat equal.<span class="function">c </span></div><div class="line"><span class="title">if</span><span class="params">(a==b &amp;&amp; b == c)</span></div><div class="line">&#123;</div><div class="line">	<span class="comment">/* some blank char follow */</span>      </div><div class="line">	<span class="keyword">if</span> (c== d)</div><div class="line">	&#123;</div><div class="line">		func(a,b, c)</div><div class="line">		func(d,e, f)</div><div class="line">		func(a, b, c)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中有这几种不规范的情况</p>
<ol>
<li>if后面不加空格</li>
<li>==前后不加空格</li>
<li>逗号后面不加空格</li>
<li>行尾有空白</li>
</ol>
<p>所以看起来十分乱。</p>
<p>废话不多说，先给出格式化脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">#!/bin/sed -f                                                               </div><div class="line"></div><div class="line"># 处理==两边加空格情况</div><div class="line"># a== b to a == b</div><div class="line">s/\([^ ]\)\(==\)/\1 \2/g</div><div class="line"># a ==b to a == b</div><div class="line">s/\(==\)\([^ ]\)/\1 \2/g</div><div class="line"></div><div class="line"># 处理&amp;&amp;两边加空格情况</div><div class="line"># a&amp;&amp; b to a &amp;&amp; b</div><div class="line">s/\([^ ]\)\(&amp;&amp;\)/\1 \2/g</div><div class="line"># a &amp;&amp;b to a &amp;&amp; b</div><div class="line">s/\(&amp;&amp;\)\([^ ]\)/\1 \2/g</div><div class="line"></div><div class="line"># 处理!=两边加空格情况</div><div class="line"># a!= b to a != b</div><div class="line">s/\([^ ]\)\(!=\)/\1 \2/g</div><div class="line"># a !=b to a != b</div><div class="line">s/\(!=\)\([^ ]\)/\1 \2/g</div><div class="line"></div><div class="line"># 处理if后面加空格情况</div><div class="line"># if(...) to if (...)</div><div class="line">s/if(/if (/g</div><div class="line"></div><div class="line"># 处理for后面加空格情况</div><div class="line"># for(...) to for (...)</div><div class="line">s/for(/for (/g</div><div class="line"></div><div class="line"># 处理逗号后面加空格情况</div><div class="line"># (a,b,c) to (a, b, c) </div><div class="line">s/\(,\)\([^ \t]\)/, \2/g</div><div class="line"></div><div class="line"># 处理行尾空格情况</div><div class="line"># remove tailing blanks</div><div class="line">s/[ \t]*$//g</div></pre></td></tr></table></figure>
<p>用上面我们的sed脚本格式化一下，看到几个不规范的情况都修正了。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$ ./ident.sed   ./equal.<span class="function">c </span></div><div class="line"><span class="title">if</span> <span class="params">(a == b &amp;&amp; b == c)</span></div><div class="line">&#123;</div><div class="line">	<span class="comment">/* some blank char follow */</span></div><div class="line">	<span class="keyword">if</span> (c == d)</div><div class="line">	&#123;</div><div class="line">		func(a, b, c)</div><div class="line">		func(d, e, f)</div><div class="line">		func(a, b, c)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后测试了一个比较大的c文件，没有发现啥bug。但是字符串里面的也会格式化，需要注意一下。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术分享/">技术分享</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sed/">sed</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/工具/">工具</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-yap-yet-another-program-profiling-tool" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/10/14/yap-yet-another-program-profiling-tool/" class="article-date">
      <time datetime="2016-10-13T23:59:13.000Z" itemprop="datePublished">2016-10-14</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/14/yap-yet-another-program-profiling-tool/">yap--yet another program profiling tool</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <blockquote>
<p>Sampling tools like oprofile or dtrace’s profile provider don’t really provide methods to see what [multithreaded] programs are blocking on - only where they spend CPU time. Though there exist advanced techniques (such as systemtap and dtrace call level probes), it is overkill to build upon that. Poor man doesn’t have time. Poor man needs food.  –quoted from <a href="https://poormansprofiler.org/" target="_blank" rel="external">poor man’s profiler</a></p>
</blockquote>
<p>Just as the name implies, this is an enhenced version of poor man’s profiler with the following new features added:</p>
<ol>
<li>support command line argument, which make it easier to use and easier to integrate to your program.</li>
<li>support multi process profiling, which is good for PostgreSQL profiling.</li>
<li>user can choose how many stack level to print, which make the result set shorter and easier to read.</li>
<li>when stack level is set to 1 , instead of the stack ranking, the function ranking is printed</li>
<li>the result set is neater and much more pretty.</li>
</ol>
<h2 id="INSTALL"><a href="#INSTALL" class="headerlink" title="INSTALL"></a>INSTALL</h2><p>Download it from <code>https://github.com/shenyuflying/yap.git</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git clone https://github.com/shenyuflying/yap.git</div></pre></td></tr></table></figure></p>
<p>Type <code>yap -h</code> to show the help message.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"># ./yap -h</div><div class="line">================================================================</div><div class="line">                          YAP    ver0.1                         </div><div class="line">================================================================</div><div class="line">  yap -- yet another profiling tool based on poor man&apos;s profiler</div><div class="line">         to generate stack rank of your program.                </div><div class="line">                                                                </div><div class="line">                             yshen 2016 see http://shenyu.wiki  </div><div class="line">================================================================</div><div class="line">                                                         </div><div class="line">usage: yap options=values</div><div class="line">        -s | --samples=n      how many samples to collect</div><div class="line">        -t | --sleeptime=n    how many time to sleep during each sample</div><div class="line">        -f | --stackframe=n   how deep the stack frame to output</div><div class="line">        -p | --pid=pid        which pid to analyze</div><div class="line">        -n | --progname=name  which program to analyze, good for multi-process profiling</div><div class="line">        -h | --help           show this help</div></pre></td></tr></table></figure></p>
<p>if the message is shown, the yap is ready to work.</p>
<h2 id="HOW-TO-USE"><a href="#HOW-TO-USE" class="headerlink" title="HOW TO USE"></a>HOW TO USE</h2><p>You need at least specify a progname or a pid to let yap attach to your program.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># ./yap  --progname=postgres</div></pre></td></tr></table></figure></p>
<p>will be enough for the yap to run. after you have choosen a program to profile, you will be run with the default configurations, and <code>yap</code> is start working.<br>the default configurations are<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">samples=100   # take 100 samples of your program</div><div class="line">sleeptime=0   # no sleep during each iteration</div><div class="line">stackframe=5  # the stack frame depth is 5</div></pre></td></tr></table></figure></p>
<p>it will take a while and there will be a progress indicator on the screen, so take your time.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># ./yap  --progname=postgres</div><div class="line">1/100 completed.</div><div class="line">2/100 completed.</div><div class="line">3/100 completed.</div><div class="line">4/100 completed.</div><div class="line">5/100 completed.</div><div class="line">...</div><div class="line">100/100 complete.</div></pre></td></tr></table></figure></p>
<p>when done, the stack ranking is printed.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">40 __epoll_wait_nocancel	WaitEventSetWaitBlock	WaitEventSetWait	WaitLatchOrSocket	WaitLatch</div><div class="line">10 __select_nocancel	ServerLoop	PostmasterMain	main</div><div class="line">10 __epoll_wait_nocancel	WaitEventSetWaitBlock	WaitEventSetWait	WaitLatchOrSocket	SysLoggerMain</div><div class="line">10 __epoll_wait_nocancel	WaitEventSetWaitBlock	WaitEventSetWait	WaitLatchOrSocket	PgstatCollectorMain</div><div class="line">1</div></pre></td></tr></table></figure></p>
<p>if you want to seek the function ranking rather than stack ranking, use <code>--stackframe=1</code> and re-run yap</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">60 __epoll_wait_nocancel</div><div class="line">10 __select_nocancel</div><div class="line"> 1</div></pre></td></tr></table></figure>
<p>the function ranking is much sorter and easier to find the slowest functions.</p>
<h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><ol>
<li>shall be run in a time duration, add -b | –begin and -e | –end and -d | –duration</li>
<li>shall be exit when the profiling program exit</li>
<li>…</li>
</ol>
<p>report bugs to shenyufly@163.com</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/开源社区/">开源社区</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Shell/">Shell</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/编程语言/">编程语言</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-PostgreSQL性能分析" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/10/13/PostgreSQL性能分析/" class="article-date">
      <time datetime="2016-10-13T04:49:37.000Z" itemprop="datePublished">2016-10-13</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/13/PostgreSQL性能分析/">PostgreSQL性能分析</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
              <blockquote>
<p>面对客户抱怨诸如“很慢”、“卡顿”等问题的时候，我们该如何找出性能瓶颈？从研发角度来说，做一下性能分析(profiling)可能有所帮助。性能分析能找出来最慢的函数，从而发现性能问题的瓶颈。再从瓶颈入手，优化代码从而解决性能问题。</p>
</blockquote>
<p>常用的方法是gdb或pstack堆栈跟踪，比如postgreSQL经常卡在一个特定的地方很长时间，往往都有相同的堆栈跟踪信息。我们要做的就是用gdb附加到进程，将所有进程堆栈打出来，然后利用一些简单的脚本将信息做汇总，再利用sort|uniq|sort的方法排序统计出最多的堆栈信息，或最多的函数调用信息。</p>
<p>其实这种profile工具已经有了，其中一个简洁有效的工具是<a href="https://poormansprofiler.org/">poor man’s profiler</a>，Google, Facebook, Wikipedia, Intel的工程师都在用这个工具来分析程序的性能。在这里我对其改造一番，使得其更方便的分析postgreSQL数据库。</p>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># ./poormansprofile.sh  </div><div class="line">usage: promansprofile username samples sleeptime</div></pre></td></tr></table></figure>
<p>username是postgreSQL登陆的用户名，脚本里来找到对应用户的pid<br>samples是采样点数<br>sleeptime是每采样点数间隔<br>比如我们分析<code>yshen</code>用户进程，采样点300个，那么如下命令启动分析：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># ./poormansprofile.sh  yshen 300 0</div><div class="line">1/300 completed.</div><div class="line">2/300 completed.</div><div class="line">3/300 completed.</div><div class="line">4/300 completed.</div><div class="line">5/300 completed.</div><div class="line">.</div><div class="line">.</div><div class="line">.</div><div class="line">300/300 completed.</div></pre></td></tr></table></figure></p>
<p>PS: 在有些环境下，需要用root用户。</p>
<h2 id="分析结果"><a href="#分析结果" class="headerlink" title="分析结果"></a>分析结果</h2><p>这个脚本可以分析</p>
<ul>
<li>函数排名：即哪个函数调用最占时间。</li>
<li>堆栈排名：即种调用堆栈最占用时间。</li>
</ul>
<h4 id="函数排名"><a href="#函数排名" class="headerlink" title="函数排名"></a>函数排名</h4><p>如下是跑回归测试的函数排名分析。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">266 ServerLoop</div><div class="line">266 PostmasterMain</div><div class="line">266 PostgresMain</div><div class="line">266 main</div><div class="line">266 BackendStartup</div><div class="line">266 BackendRun</div><div class="line">259 exec_simple_query</div><div class="line">134 CommitTransactionCommand</div><div class="line">134 CommitTransaction</div><div class="line">132 XLogFlush</div><div class="line">132 RecordTransactionCommit</div><div class="line">129 finish_xact_command</div><div class="line">128 XLogWrite</div><div class="line">128 pg_fdatasync</div><div class="line">128 issue_xlog_fsync</div><div class="line">128 __fdatasync_nocancel</div><div class="line">120 PortalRun</div><div class="line">101 standard_ProcessUtility</div><div class="line">101 ProcessUtility</div><div class="line"> 99 PortalRunMulti</div><div class="line"> 96 PortalRunUtility</div><div class="line"> 75 ProcessUtilitySlow</div><div class="line"> 74 smgrimmedsync</div><div class="line"> 74 pg_fsync_no_writethrough</div><div class="line"> 74 pg_fsync</div><div class="line"> 74 mdimmedsync</div><div class="line"> 74 __fsync_nocancel</div><div class="line"> 74 FileSync</div><div class="line"> 73 index_build</div><div class="line"> 69 btbuild</div></pre></td></tr></table></figure></p>
<p>可以看到ServerLoop这个函数最占用时间，很正常，因为这个函数在等待用户连接。下面几个函数其中有个函数XLogFlush，FileSync，smgrimmedsync，pg_fdatasync等等都是IO相关，可见IO非常耗时。以上是正常状态下的函数排名，如果有异常应该就可以发现，比如一些阻塞行为，死锁，IO，网络问题都能在这里发现。</p>
<h2 id="堆栈排名"><a href="#堆栈排名" class="headerlink" title="堆栈排名"></a>堆栈排名</h2><p>堆栈排名更加详细，说了哪种堆栈状态最耗时。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">45 __fdatasync_nocancel,pg_fdatasync,issue_xlog_fsync,XLogWrite,XLogFlush,RecordTransactionCommit,CommitTransaction,CommitTransactionCommand,finish_xact_command,exec_simple_query,PostgresMain,BackendRun,BackendStartup,ServerLoop,PostmasterMain,main</div><div class="line"> 7 __fsync_nocancel,pg_fsync_no_writethrough,pg_fsync,FileSync,mdimmedsync,smgrimmedsync,_bt_load,_bt_leafbuild,btbuild,index_build,index_create,DefineIndex,ProcessUtilitySlow,standard_ProcessUtility,ProcessUtility,PortalRunUtility,PortalRunMulti,PortalRun,exec_simple_query,PostgresMain,BackendRun,BackendStartup,ServerLoop,PostmasterMain,main</div><div class="line"> 4 __fsync_nocancel,pg_fsync_no_writethrough,pg_fsync,FileSync,mdimmedsync,smgrimmedsync,_bt_load,_bt_leafbuild,btbuild,index_build,index_create,create_toast_table,CheckAndCreateToastTable,NewRelationCreateToastTable,ProcessUtilitySlow,standard_ProcessUtility,ProcessUtility,PortalRunUtility,PortalRunMulti,PortalRun,exec_simple_query,PostgresMain,BackendRun,BackendStartup,ServerLoop,PostmasterMain,mai</div></pre></td></tr></table></figure></p>
<p>分析第一个堆栈，出现了45次，堆栈的内容是CommitTransaction提交事务带来的刷盘持久化操作，可见很耗时啊，因为带来了IO。同样的，如果发现什么异常行为也可以在这里发现。</p>
<h2 id="源码1-——只分析用户进程"><a href="#源码1-——只分析用户进程" class="headerlink" title="源码1 ——只分析用户进程"></a>源码1 ——只分析用户进程</h2><p>源码如下：<br>如果去掉<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sed &apos;s/,/\n/g&apos; | \</div><div class="line">uniq | \</div></pre></td></tr></table></figure></p>
<p>这两行就是显示的堆栈排名，否则是函数排名。</p>
          
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术分享/">技术分享</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PostgreSQL/">PostgreSQL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PostgreSQL使用/">PostgreSQL使用</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/数据库/">数据库</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/调优/">调优</a></li></ul>
    </div>

      
        <p class="article-more-link">
          <a href="/2016/10/13/PostgreSQL性能分析/#more">阅读全文 >></a>
        </p>
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-PostgreSQL日志分析工具——pgBadger" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/10/13/PostgreSQL日志分析工具——pgBadger/" class="article-date">
      <time datetime="2016-10-12T23:29:26.000Z" itemprop="datePublished">2016-10-13</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/13/PostgreSQL日志分析工具——pgBadger/">PostgreSQL日志分析工具——pgBadger</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <blockquote>
<p>面对客户抱怨诸如“很慢”、“卡顿”等问题的时候，常用的办法就是查看服务器的日志。但是一头扎进几百M甚至几个G的日志里查看并不现实。那么如何快速回答：最慢的查询有哪些？查询相应时间分布？等等问题，并对最突出的问题着手优化呢？显然我们需要借助自动化工具来完成这个任务。</p>
</blockquote>
<p>pgBadger就是为分析<code>PostgreSQL全日志</code>为目的诞生的一个工具，能够分析日志并生成分析报告，<a href="/uploads/out.html">这里</a>给出了一个报告样本。怎么样，报告是不是很详细？</p>
<h2 id="pdBadger安装"><a href="#pdBadger安装" class="headerlink" title="pdBadger安装"></a>pdBadger安装</h2><p>pgBadger代码托管在github上，可以到<a href="https://github.com/dalibo/pgbadger/releases" target="_blank" rel="external">这里</a>进行下载，最新的版本是<a href="https://github.com/dalibo/pgbadger/archive/v9.0.tar.gz" target="_blank" rel="external">v9.0</a><br>安装步骤页十分简单：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">wget https://github.com/dalibo/pgbadger/archive/v9.0.tar.gz</div><div class="line">tar xzf pgbadger-9.0.tar.gz</div><div class="line">cd pgbadger-9.x/</div><div class="line">perl Makefile.PL</div><div class="line">make &amp;&amp; sudo make install</div></pre></td></tr></table></figure></p>
<p>安装完后，在终端执行<code>pgbadger --version</code>显示版本信息后，表明安装成功。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ pgbadger --version</div><div class="line">pgBadger version 9.0</div></pre></td></tr></table></figure></p>
<h2 id="收集PostgreSQL日志"><a href="#收集PostgreSQL日志" class="headerlink" title="收集PostgreSQL日志"></a>收集PostgreSQL日志</h2><p>要利用pgbadger来分析日志，那么我们首先要打开PostgreSQL记录日志的参数，如下是一个典型的配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">log_min_duration_statement = 0 </div><div class="line">log_checkpoints = on</div><div class="line">log_connections = on</div><div class="line">log_disconnections = on</div><div class="line">log_lock_waits = on</div><div class="line">log_temp_files = 0 </div><div class="line">log_autovacuum_min_duration = 0 </div><div class="line">log_line_prefix = &apos;%t [%p]: [%l-1] db=%d,user=%u,app=%a,client=%h&apos;</div><div class="line">log_destination = &apos;stderr&apos;  </div><div class="line">logging_collector = on    </div><div class="line">log_directory = &apos;pg_log&apos;</div><div class="line">log_filename = &apos;postgresql-%Y-%m-%d_%H%M%S.log&apos;</div><div class="line">log_file_mode = 0600</div><div class="line">log_rotation_age = 1d</div><div class="line">log_rotation_size = 1000MB</div><div class="line">lc_messages=&apos;C&apos;</div></pre></td></tr></table></figure></p>
<p>接着打开数据库，如果数据库正在运行那么需要发送一个SIGHUP信号来让数据库重新读取配置。过段时间，我们就能够在<code>pg_log</code>文件夹下看到日志产生了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ ls</div><div class="line">postgresql-2016-10-13_113844.log</div></pre></td></tr></table></figure></p>
<h2 id="生成分析报告"><a href="#生成分析报告" class="headerlink" title="生成分析报告"></a>生成分析报告</h2><p>生成分析报告非常简单只需要一步<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ pgbadger ./postgresql-2016-10-13_113844.log</div><div class="line">[========================&gt;] Parsed 5642240 bytes of 5642240 (100.00%), queries: 19436, events: 3002</div><div class="line">LOG: Ok, generating html report...</div></pre></td></tr></table></figure></p>
<p>稍等片刻就会输出分析报告<a href="/uploads/out.html">out.html</a></p>
<p>当然了，pgbadger还有一些高端玩法，比如</p>
<ul>
<li><p>分析压缩文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pgbadger /var/log/postgres.log.1.tar.gz</div></pre></td></tr></table></figure>
</li>
<li><p>分析多个文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pgbadger /var/log/postgresql/postgresql-2012-05-*</div></pre></td></tr></table></figure>
</li>
<li><p>排除某些类型查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pgbadger --exclude-query=&quot;^(COPY|COMMIT)&quot; /var/log/postgresql.log</div></pre></td></tr></table></figure>
</li>
<li><p>指定起始时间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pgbadger -b &quot;2012-06-25 10:56:11&quot; -e &quot;2012-06-25 10:59:11&quot; </div><div class="line">                       /var/log/postgresql.log</div></pre></td></tr></table></figure>
</li>
<li><p>从管道读取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cat /var/log/postgres.log | pgbadger -</div></pre></td></tr></table></figure>
</li>
<li><p>开启多进程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">perl pgbadger -j 8 /pglog/postgresql-9.1-main.log</div></pre></td></tr></table></figure>
</li>
</ul>
<p>也可以把pgbadger加入crontab计划中，来实现生成每周报告等等。</p>
<h2 id="报告分析"><a href="#报告分析" class="headerlink" title="报告分析"></a>报告分析</h2><p>报告包括了很多方面的内容：</p>
<p>总体信息</p>
<ul>
<li>服务器traffic信息，比如select、update、insert情况</li>
<li>连接情况信息，比如每个库、用户连接情况</li>
<li>会话信息，比如会话时长</li>
<li>checkpoint检查点信息</li>
<li>临时文件信息</li>
<li>vacuum信息，比如做vacuum时间分布，做vacuum表情况，删除元组、页面信息</li>
<li>等待锁的信息</li>
<li>查询信息，insert/update/delete比例分布</li>
<li>慢查询排名，查询耗时分布</li>
<li>报错信息</li>
</ul>
<p>下面介绍一下主要的几个内容</p>
<h3 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h3><p><img src="http://static.zybuluo.com/shenyuflying/f65eqmftm1egi0k8vkm68ub4/image_1auubla73147a1j8r1sf53a11ejq9.png" alt="image_1auubla73147a1j8r1sf53a11ejq9.png-27.5kB"></p>
<h3 id="QPS"><a href="#QPS" class="headerlink" title="QPS"></a>QPS</h3><p><img src="http://static.zybuluo.com/shenyuflying/qtlgqigexi461t1ixoppuxkd/image_1auubnceb1ah08qorkt1hct1tf3m.png" alt="image_1auubnceb1ah08qorkt1hct1tf3m.png-46.6kB"></p>
<p>这里可以看到有关服务器压力的信息。</p>
<h3 id="查询时间分布-Histogram-of-query-times"><a href="#查询时间分布-Histogram-of-query-times" class="headerlink" title="查询时间分布 Histogram of query times"></a>查询时间分布 Histogram of query times</h3><p><img src="http://static.zybuluo.com/shenyuflying/n5eyqk5866jo00x082uubo63/image_1auubrt19117m130akqdhgbcd513.png" alt="image_1auubrt19117m130akqdhgbcd513.png-38.5kB"></p>
<p>这里可以看到查询时间分布的信息。</p>
<h3 id="慢查询排名-Slowest-individual-queries"><a href="#慢查询排名-Slowest-individual-queries" class="headerlink" title="慢查询排名 Slowest individual queries"></a>慢查询排名 Slowest individual queries</h3><p><img src="http://static.zybuluo.com/shenyuflying/b608kg30v8brh5m4mfupw7xt/image_1auubtkfr1kvfuke1dqiknii6p1g.png" alt="image_1auubtkfr1kvfuke1dqiknii6p1g.png-161.8kB"><br>这里可以看到慢查询信息。<br>另外还有<br>Time Consuming queries (N) —— 最耗时的查询<br>Most frequent queries (N) ——　最频繁的查询<br>Normalized slowest queries　——　归一化后最慢的查询</p>
<p>PS：这里的归一化，就是排除参数不同的干扰。</p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>另外报告中还有关于报错信息的统计和详细情况。有助于发现服务器的故障。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过pgbadger可以快速分析几百M甚至几个G的服务器日志。掌握服务器运行情况并快速回答：最慢的查询有哪些？查询相应时间分布？等等问题。有助于对最突出的问题着手优化。从而快速解决客户的抱怨。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术分享/">技术分享</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PostgreSQL/">PostgreSQL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PostgreSQL使用/">PostgreSQL使用</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/数据库/">数据库</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/调优/">调优</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/6/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/8/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2014-2017 小宇
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit"  title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





    <script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>