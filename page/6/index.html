<!DOCTYPE html>
<html lang="zh-Hans">
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="小宇" />


    
    


<meta name="description" content="Shen Yu">
<meta property="og:type" content="website">
<meta property="og:title" content="小宇的博客">
<meta property="og:url" content="http://shenyu.wiki/page/6/index.html">
<meta property="og:site_name" content="小宇的博客">
<meta property="og:description" content="Shen Yu">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="小宇的博客">
<meta name="twitter:description" content="Shen Yu">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">
<link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css" rel="stylesheet">
<link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">

<!-- for mermaid -->


    <link rel="alternate" href="/atom.xml" title="小宇的博客" type="application/atom+xml">



    <link rel="shortcut icon" href="/uploads/siteicon.png">





    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">



<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>小宇的博客</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: false,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: true
    }
	
</script>


    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/uploads/avatar.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">小宇</a></h1>
        </hgroup>

        
        <p class="header-subtitle">statistics</p>
        

        
            <form id="search-form">
            <input type="text" id="local-search-input" name="q" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off" searchonload="true" />
            <i class="fa fa-times" onclick="resetSearch()"></i>
            </form>
            <div id="local-search-result"></div>
            <p class='no-result'>No results found <i class='fa fa-spinner fa-pulse'></i></p>
        


        <p class="header-subtitle">文章: 101 字数: 507393</p>
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-home icon-2x">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">归档</a></li>
                        
                            <li><a href="/tags/">标签</a></li>
                        
                            <li><a href="/map/">导航</a></li>
                        
                            <li><a href="/message/">留言</a></li>
                        
                            <li><a href="/about/">关于</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:shenyufly@163.com" title="Email"></a>
                            
                                <a class="fa GitHub" href="http://github.com/shenyuflying" title="GitHub"></a>
                            
                                <a class="fa RSS" href="http://1572339ac8.iok.la:34421" title="RSS"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/DTCC/">DTCC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ECPG/">ECPG</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Greenplum/">Greenplum</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux使用/">Linux使用</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux编程/">Linux编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OCI/">OCI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ODBC/">ODBC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Oracle/">Oracle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PLSQL/">PLSQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PostgreSQL/">PostgreSQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PostgreSQL使用/">PostgreSQL使用</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PostgreSQL内核/">PostgreSQL内核</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PostgreSQL接口/">PostgreSQL接口</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shell/">Shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/assembly/">assembly</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/">c</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cctree/">cctree</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cflow/">cflow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/codeviz/">codeviz</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/debug/">debug</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dns/">dns</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dnsmasq/">dnsmasq</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/doxygen/">doxygen</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/egypt/">egypt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/events/">events</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gdb/">gdb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/">golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gprof/">gprof</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kcachegrind/">kcachegrind</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mathjax/">mathjax</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nas/">nas</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nextcloud/">nextcloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sed/">sed</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/">shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/valgrind/">valgrind</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vim/">vim</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wget/">wget</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/基础知识/">基础知识</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/备份还原/">备份还原</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/小宇带你学PostgreSQL内核/">小宇带你学PostgreSQL内核</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/工具/">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/开源社区/">开源社区</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/技术分享/">技术分享</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/接口/">接口</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/操作系统/">操作系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据库/">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据库，PostgreSQL/">数据库，PostgreSQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/文章/">文章</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/旅行/">旅行</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/本地化/">本地化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/架构/">架构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/查询优化/">查询优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/树莓派/">树莓派</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/汇编调试方法/">汇编调试方法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/爱好/">爱好</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/编程/">编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/编程语言/">编程语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网站/">网站</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/语言层/">语言层</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/读书/">读书</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/调优/">调优</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://pages.github.com/">GitHub</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://moxfive.xyz/">MOxFIVE</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">专注于基础软件研发</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">小宇</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/uploads/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">小宇</a></h1>
            </hgroup>
            
            <p class="header-subtitle">statistics</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">归档</a></li>
                
                    <li><a href="/tags/">标签</a></li>
                
                    <li><a href="/map/">导航</a></li>
                
                    <li><a href="/message/">留言</a></li>
                
                    <li><a href="/about/">关于</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:shenyufly@163.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="http://github.com/shenyuflying" title="GitHub"></a>
                            
                                <a class="fa RSS" target="_blank" href="http://1572339ac8.iok.la:34421" title="RSS"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap">
  
    <article id="post-PostgreSQL中的spinlock实现的基本原理" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/11/13/PostgreSQL中的spinlock实现的基本原理/" class="article-date">
      <time datetime="2016-11-12T18:48:32.000Z" itemprop="datePublished">2016-11-13</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/13/PostgreSQL中的spinlock实现的基本原理/">PostgreSQL中的spinlock实现的基本原理</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
              <blockquote>
<p>linux中锁实现方法有文件锁、mutex、semaphore等。在PostgreSQL设计过程中，考虑到mutex、semaphore具有一定的限制，为了性能和可移植性考虑，对于比较短时间的等待，spinlock性能更好。那么spinlock是怎么实现的呢？</p>
</blockquote>
<p>spinlock依赖于test and set，即先测试一个变量的值是否为0，这一步叫test；如果为0则现在没有加锁，那么接下来设置为1加锁，这一步叫set；如果加锁之后，接下来再次加锁test为1则用一个while循环不断等待，从而实现了加锁的功能。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">spin_lock</span><span class="params">(<span class="keyword">lock_t</span> *lock)</span></div><div class="line"></span>&#123;</div><div class="line">	<span class="keyword">while</span>(tas(lock)==<span class="number">1</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>解锁相对简单，直接把变量设为0即可。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">spin_unlock</span><span class="params">(<span class="keyword">lock_t</span> *lock)</span></div><div class="line"></span>&#123;</div><div class="line">	*lock = <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>首先需要我们实现一个满足上面要求的tas函数，即函数检查一个内存中的值，看是否为0，如果为0，那么set设置为1，并返回0。如果为1则直接返回1。由于并发原因，必须确保set的原子性，即set的指令必须全部一次执行成功，中间不能出现中断。比如：<br>要把寄存器al=1的值放入内存(%rcx)，并把内存(%rcx)放入寄存器al其实是一个exchange交换操作，一般需要3条指令，其中用到了一个临时寄存器，比如<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mov (%rcx) ah</div><div class="line">mov al     (%rcx)</div><div class="line">mov ah     al</div></pre></td></tr></table></figure></p>
<p>现在要求如上3条汇编具有原子性，即可以用一条汇编指令来实现，这个操作可以在汇编中用<code>lock xchg</code>来实现。</p>
<p>现在我们查看在PostgreSQL中一段加锁的汇编代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">  40073e:   cmpb   $0x0,(%rcx)  ;test是不是为0</div><div class="line">  400741:   jne    400746 &lt;TAS_LOCK+0x20&gt; ;如果不是0，那么直接返回</div><div class="line">  400743:   lock xchg %al,(%rcx) ;如果是0，那么设置为1</div><div class="line">  400746:   mov    %eax,%ebx ;返回结果</div><div class="line">  400748:   movzbl %bl,%eax</div><div class="line">  40074b:   pop    %rbx</div><div class="line">  40074c:   pop    %rbp</div><div class="line">  40074d:   retq</div></pre></td></tr></table></figure></p>
<p>按照其原理，通过对其进行反汇编，得到如下的c语言函数：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="number">__</span><span class="function">inline__ <span class="keyword">int</span></div><div class="line"><span class="title">tas</span><span class="params">(<span class="keyword">volatile</span> <span class="keyword">lock_t</span> *lock)</span></div><div class="line"></span>&#123;</div><div class="line">    <span class="keyword">register</span> <span class="keyword">lock_t</span> <span class="number">_</span>res = <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="number">__</span>asm__ <span class="number">__</span>volatile__(</div><div class="line">        <span class="string">"   cmpb    $0,%1   \n"</span></div><div class="line">        <span class="string">"   jne     1f      \n"</span></div><div class="line">        <span class="string">"   lock            \n"</span></div><div class="line">        <span class="string">"   xchgb   %0,%1   \n"</span></div><div class="line">        <span class="string">"1: \n"</span></div><div class="line">:       <span class="string">"+q"</span>(<span class="number">_</span>res), <span class="string">"+m"</span>(*lock)</div><div class="line">:       <span class="comment">/* no inputs */</span></div><div class="line">:       <span class="string">"memory"</span>, <span class="string">"cc"</span>);</div><div class="line">    <span class="keyword">return</span> (<span class="keyword">int</span>) <span class="number">_</span>res;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>下面通过一段并发程序，来检验一下。下面的程序首先在共享内存中创建了一个变量count，接下来fork了两个进程分别对count递增了1000000次，在递增的时候用我们上面描述的spinlock来加锁保护。最后打出了结果，正确的结果是2000000.</p>
          
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术分享/">技术分享</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PostgreSQL/">PostgreSQL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PostgreSQL内核/">PostgreSQL内核</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/数据库/">数据库</a></li></ul>
    </div>

      
        <p class="article-more-link">
          <a href="/2016/11/13/PostgreSQL中的spinlock实现的基本原理/#more">阅读全文 >></a>
        </p>
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-linux中进程共享内存的2种方法" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/11/12/linux中进程共享内存的2种方法/" class="article-date">
      <time datetime="2016-11-12T03:27:10.000Z" itemprop="datePublished">2016-11-12</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/12/linux中进程共享内存的2种方法/">linux中进程共享内存的2种方法</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
              <blockquote>
<p>共享内存可以在两个或多个进程间共享一个给定的内存区域，因为数据不需要在进程之间复制，相比于pipe、socket、file等共享通信方式，共享内存是最快的一种共享机制。linux中共享内存一般有2种方法即:shared memory和mmap。</p>
</blockquote>
<p>下面两个例子都是首先在主进程里创建一段共享内存，然后通过fork创建一个子进程。子进程在共享内存里写入Hello world，父进程等待子进程退出之后读取共享内存中的内容并显示出来。<br>下面通过两个实例源码来介绍。</p>
          
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术分享/">技术分享</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux编程/">Linux编程</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c/">c</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/操作系统/">操作系统</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/编程语言/">编程语言</a></li></ul>
    </div>

      
        <p class="article-more-link">
          <a href="/2016/11/12/linux中进程共享内存的2种方法/#more">阅读全文 >></a>
        </p>
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-linux进程改名" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/11/10/linux进程改名/" class="article-date">
      <time datetime="2016-11-10T00:16:26.000Z" itemprop="datePublished">2016-11-10</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/10/linux进程改名/">linux进程改名</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <blockquote>
<p>在多进程程序中，用ps命令能看到进程的名字。这样能够方便管理，不会因为看到好多同样的进程而不知道他们在干什么而茫然，同时也能避免管理员kill掉错误的进程。</p>
</blockquote>
<p>比如PostgreSQL刚启动时共有7个进程，通过ps可以清楚的看到每个进程是干什么的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ ps ax | grep postgres</div><div class="line">26300 pts/26   S      0:00 ./postgres -D ../data</div><div class="line">26301 ?        Ss     0:00 postgres: logger process  </div><div class="line">26303 ?        Ss     0:00 postgres: checkpointer process  </div><div class="line">26304 ?        Ss     0:00 postgres: writer process  </div><div class="line">26305 ?        Ss     0:00 postgres: wal writer process  </div><div class="line">26306 ?        Ss     0:00 postgres: autovacuum launcher process  </div><div class="line">26307 ?        Ss     0:00 postgres: stats collector process</div></pre></td></tr></table></figure>
<p>那么在linux下是如何做到进程改名的呢？</p>
<h2 id="方法1–修改argv-0"><a href="#方法1–修改argv-0" class="headerlink" title="方法1–修改argv[0]"></a>方法1–修改argv[0]</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span>                                                                             #<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">memcpy</span>(argv[<span class="number">0</span>],<span class="string">"hello world"</span>,<span class="keyword">sizeof</span>(<span class="keyword">char</span>)*<span class="built_in">strlen</span>(argv[<span class="number">0</span>]));</div><div class="line">    sleep(<span class="number">100</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">yshen@yshen-office:~/test/procname$ ./main &amp;</div><div class="line">[2] 26903</div><div class="line">yshen@yshen-office:~/test/procname$ ps</div><div class="line">  PID TTY          TIME CMD</div><div class="line">26903 pts/14   00:00:00 main</div><div class="line">yshen@yshen-office:~/test/procname$ ps ax | grep hello</div><div class="line">26903 pts/14   S      0:00 hello</div></pre></td></tr></table></figure>
<p>问题：ps不起效果，ps ax才能看到。不知到为啥。<br>其实PostgreSQL中就是用的这种方法，详见ps_status.c这个文件。</p>
<h2 id="方法2–用prctl"><a href="#方法2–用prctl" class="headerlink" title="方法2–用prctl"></a>方法2–用prctl</h2><p>需要Linux 2.1.57版本以上。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/prctl.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/wait.h&gt;</span></span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">char</span> *progname = <span class="literal">NULL</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">setproctitle</span><span class="params">(<span class="keyword">char</span> *title)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">char</span> buf[<span class="number">256</span>];</div><div class="line"></div><div class="line">	<span class="built_in">sprintf</span>(buf,<span class="string">"%s: %s"</span>, progname, title);</div><div class="line">	<span class="keyword">if</span> (<span class="number">0</span> != prctl(PR_SET_NAME,buf,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>))</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"error prctl, errno=%d, errstr=%s\n"</span>, errno, strerror(errno));</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">char</span> *<span class="title">getproctitle</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">char</span> *ret = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">char</span>)*<span class="number">16</span>);</div><div class="line">	<span class="keyword">if</span> (<span class="number">0</span> != prctl(PR_GET_NAME,ret,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>))</div><div class="line">	&#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"error prctl, errno=%d, errstr=%s\n"</span>, errno, strerror(errno));</div><div class="line">		<span class="built_in">free</span>(ret);</div><div class="line">		ret = <span class="literal">NULL</span>;</div><div class="line">		</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> ret;</div><div class="line"></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">pid_t</span> pid;</div><div class="line">	progname = strdup(argv[<span class="number">0</span>]);</div><div class="line">	</div><div class="line">	<span class="keyword">switch</span>(pid = fork())</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">case</span> <span class="number">0</span>:</div><div class="line">		&#123;</div><div class="line">			<span class="comment">/* child */</span></div><div class="line">			setproctitle(<span class="string">"child"</span>);</div><div class="line">			sleep(<span class="number">100</span>);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">case</span> <span class="number">-1</span>:</div><div class="line">		&#123;</div><div class="line">			<span class="built_in">printf</span>(<span class="string">"fork falied!\n"</span>);</div><div class="line">			<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">default</span>:</div><div class="line">		&#123;</div><div class="line">			<span class="comment">/* parent */</span></div><div class="line">			setproctitle(<span class="string">"parent"</span>);</div><div class="line">			sleep(<span class="number">100</span>);</div><div class="line">			wait(<span class="literal">NULL</span>);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ ./main  &amp;</div><div class="line">[1] 26917</div><div class="line">$ ps</div><div class="line">  PID TTY          TIME CMD</div><div class="line">16399 pts/14   00:00:00 bash</div><div class="line">25668 pts/14   00:00:02 gedit</div><div class="line">26917 pts/14   00:00:00 ./main2: parent</div><div class="line">26918 pts/14   00:00:00 ./main2: child</div><div class="line">$ ps ax | grep main</div><div class="line">26917 pts/14   S      0:00 ./main</div><div class="line">26918 pts/14   S      0:00 ./main</div></pre></td></tr></table></figure>
<p>问题：ps ax不起效果，ps 看到。不知到为啥。</p>
<p>看来综合用这两种方法才行啊。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术分享/">技术分享</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux编程/">Linux编程</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/操作系统/">操作系统</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-PostgreSQL源码中的EXEC-BACKEND宏" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/11/09/PostgreSQL源码中的EXEC-BACKEND宏/" class="article-date">
      <time datetime="2016-11-09T00:04:10.000Z" itemprop="datePublished">2016-11-09</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/09/PostgreSQL源码中的EXEC-BACKEND宏/">PostgreSQL源码中的EXEC_BACKEND宏</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>看pg源码的时候经常会见到一个EXEC_BACKEND宏，在源码中并没有给出解释，那么它是什么意思呢？从<a href="http://postgresql.nabble.com/EXEC-BACKEND-td1991462.html这里找到了解释：" target="_blank" rel="external">http://postgresql.nabble.com/EXEC-BACKEND-td1991462.html这里找到了解释：</a></p>
<p>It exists because Windows doesn’t have fork(), only the equivalent of<br>fork-and-exec.  Which means that no state variables will be inherited<br>from the postmaster by its child processes, and any state that needs to<br>be carried across has to be handled explicitly.  You can define<br>EXEC_BACKEND in a non-Windows build, for the purpose of testing code<br>to see if it works in that environment.</p>
<p>regards, tom lane </p>
<p>意思是说用<code>EXEC_BACKEND</code>宏是因为Windows没有fork(),只好用别的方法来实现fork-and-exec。但是这样以来，生成的子进程没办法继承父进程的一些状态变量，所以状态变量必须显式的传给所有的子进程。在非Windows平台上编译的时候（比如linux）也可以定义<code>EXEC_BACKEND</code>宏来做调试。</p>
<p>可见<code>EXEC_BACKEND</code>宏是为了在win32上用来实现变量传递机制。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术分享/">技术分享</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PostgreSQL/">PostgreSQL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PostgreSQL内核/">PostgreSQL内核</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/数据库/">数据库</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-PostgreSQL-ODBC-driver-internal" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/11/09/PostgreSQL-ODBC-driver-internal/" class="article-date">
      <time datetime="2016-11-08T19:04:32.000Z" itemprop="datePublished">2016-11-09</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/09/PostgreSQL-ODBC-driver-internal/">PostgreSQL ODBC driver internal</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p><img src="http://static.zybuluo.com/shenyuflying/15buljfauji0u51n4nxoxbmk/%E5%B9%BB%E7%81%AF%E7%89%871.png" alt="幻灯片1.png-23.4kB"></p>
<p><img src="http://static.zybuluo.com/shenyuflying/71pb0f3iub67tnxwp1io8ixf/%E5%B9%BB%E7%81%AF%E7%89%872.png" alt="幻灯片2.png-99.8kB"></p>
<p><img src="http://static.zybuluo.com/shenyuflying/9hojapjxxlc9fuv751kgmbn9/%E5%B9%BB%E7%81%AF%E7%89%873.png" alt="幻灯片3.png-144.5kB"></p>
<p><img src="http://static.zybuluo.com/shenyuflying/c948ihhsyo84e5wan6ztl197/%E5%B9%BB%E7%81%AF%E7%89%874.png" alt="幻灯片4.png-63.4kB"></p>
<p><img src="http://static.zybuluo.com/shenyuflying/2tpaw767vsio8xn08cnznhwi/%E5%B9%BB%E7%81%AF%E7%89%875.png" alt="幻灯片5.png-47.7kB"></p>
<p><img src="http://static.zybuluo.com/shenyuflying/gb2ecwobm8f4xwkqmj1bhrpx/%E5%B9%BB%E7%81%AF%E7%89%8712.png" alt="幻灯片12.png-56.7kB"></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Presentations/">Presentations</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PostgreSQL内核/">PostgreSQL内核</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/技术分享/">技术分享</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/接口/">接口</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/数据库/">数据库</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-pgNodeGraph-a-postgreSQL-node-tree-print-tool" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/11/04/pgNodeGraph-a-postgreSQL-node-tree-print-tool/" class="article-date">
      <time datetime="2016-11-03T21:43:06.000Z" itemprop="datePublished">2016-11-04</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/04/pgNodeGraph-a-postgreSQL-node-tree-print-tool/">pgNodeGraph -- a postgreSQL node tree print tool</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
              <blockquote>
<p>The output of postgreSQL node tree can be very long for the developer to investigate. pgNodeGraph tool can covert the output of the node tree into jpg formatted pictiure which is quite convenient for developing or debugging purposess.</p>
</blockquote>
<p><a href="https://github.com/shenyuflying/pgNodeGraph">view source on github</a></p>
<h2 id="short-tour"><a href="#short-tour" class="headerlink" title="short tour"></a>short tour</h2><p>suppose we have a table like this<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">postgres=# \d class</div><div class="line">             Table &quot;public.class&quot;</div><div class="line">  Column   |         Type          | Modifiers </div><div class="line">-----------+-----------------------+-----------</div><div class="line"> classno   | character varying(10) | </div><div class="line"> classname | character varying(10) | </div><div class="line"> gno       | character varying(10) |</div></pre></td></tr></table></figure></p>
<p>by turning the following option on, the postgreSQL will print the node tree after parse and plan the query.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">set debug_print_parse = on;</div><div class="line">set debug_print_plan = on;</div><div class="line">set debug_pretty_print = on;</div></pre></td></tr></table></figure></p>
<p>now let’s execute a statment.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">postgres=# select * from class;</div></pre></td></tr></table></figure></p>
<p>the sever will print the parse and plan node tree in the log. according to different type of queries, the out put usually last for hundred or thousand lines. below is an example.</p>
<p><img src="http://static.zybuluo.com/shenyuflying/3pnykidt3h56e4n5ukn6e9bz/image_1at06c8lbe4r1k4lrcn1o5hll113.png" alt="image_1at06c8lbe4r1k4lrcn1o5hll113.png-32.9kB"></p>
<p>the node tree printed by of postgreSQL, as you have seen is hard for the developer or user to see it as a whole. so, is there a way to print the node tree as a picture format? the answer is yes. now, let me show you how to use pgNodeGraph to convert the node tree to a picture format.</p>
<ol>
<li>copy and paste the node tree in text form.</li>
<li>put it in node dir</li>
<li>run <code>$ ./pgNodeGraph</code><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ ./pgNodeGraph </div><div class="line">processing file sample.node ...done</div></pre></td></tr></table></figure>
</li>
</ol>
<p>after a short wait, the node tree in jpg format is generated under the pic directory.</p>
<p>QueryNodeTree：<br><img src="http://static.zybuluo.com/shenyuflying/5hpdpk2pagv927zqtajj1nu3/image_1at05s7f0n6l6i9blt0918kp9.png" alt="image_1at05s7f0n6l6i9blt0918kp9.png-421.8kB"></p>
<p>PlanNodeTree：<br><img src="http://static.zybuluo.com/shenyuflying/6ufsqp1cmsirhumjbt61r1an/image_1at0639g0ftv1fulrt1ojs105am.png" alt="image_1at0639g0ftv1fulrt1ojs105am.png-404.8kB"></p>
          
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/开源社区/">开源社区</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PostgreSQL/">PostgreSQL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c/">c</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/开源社区/">开源社区</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/技术分享/">技术分享</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/数据库/">数据库</a></li></ul>
    </div>

      
        <p class="article-more-link">
          <a href="/2016/11/04/pgNodeGraph-a-postgreSQL-node-tree-print-tool/#more">阅读全文 >></a>
        </p>
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-PostgreSQL本地化过程及维护" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/11/03/PostgreSQL本地化过程及维护/" class="article-date">
      <time datetime="2016-11-02T23:47:59.000Z" itemprop="datePublished">2016-11-03</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/03/PostgreSQL本地化过程及维护/">PostgreSQL本地化过程及维护</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
              <blockquote>
<p>PostgreSQL如果要支持本地化，那么./configure的时候要加上–enable-nls构建选项。加了该选项之后通过设置相应的locale之后，PostgreSQL显示的信息就可以是中文了。那么其中的过程是什么呢？如何在添加了新的程序或加了新的翻译字符串之后维护本地化内容呢？</p>
</blockquote>
<p>[TOC]</p>
<h2 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h2><p>.po文件： po，Portable Object，里面记录了翻译内容。<br>.mo文件： mo，Machine Object，其实是一个二进制文件，用来提供给程序使用。<br>xgettext：一个工具，根据c文件生成po文件<br>msgfmt： 一个工具，根据po文件生成mo文件<br>msgmerge：更新po文件<br>nls.mk：翻译包的配置，比如翻译哪些c文件</p>
<h2 id="基本过程"><a href="#基本过程" class="headerlink" title="基本过程"></a>基本过程</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">        xgettext            人工翻译        msgfmt          INSTALL</div><div class="line">.c文件-----------&gt;.pot文件----------&gt;.po----------&gt;.mo------------&gt;./bin/po/zh/LC_MESSAGES/.mo</div><div class="line"></div><div class="line">         gcc                              INSTALL</div><div class="line">.c文件-----------&gt;可执行文件--------------------------------------&gt;./bin</div></pre></td></tr></table></figure>
<p>基本过程如上图，首先需要xgettext工具根据.c文件生成.pot文件，接下来需要人工翻译。翻译过后用msgfmt工具把翻译好的.po文件生成.mo文件。最后把.mo文件放到制定位置即可。但是不需要我们自己直接调这些工具来完成本地化的工作，其过程都写在了<code>nls-global.mk</code>文件里面。我们只要<code>make init-po</code>、<code>make update-po</code>、<code>make install-po</code>这几个步骤即可。</p>
<p>最后生成的目录结构如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">$ tree</div><div class="line">.</div><div class="line">├── psql.c</div><div class="line">...</div><div class="line">├── Makefile</div><div class="line">├── nls.mk</div><div class="line">├── po</div><div class="line">│   ├── cs.mo</div><div class="line">│   ├── cs.po</div><div class="line">...</div><div class="line">│   ├── zh_CN.mo</div><div class="line">│   ├── zh_CN.po</div><div class="line">│   ├── zh_TW.mo</div><div class="line">│   └── zh_TW.po</div><div class="line"></div><div class="line">├── prompt.c</div><div class="line">...</div><div class="line"></div><div class="line">1 directory, 65 files</div></pre></td></tr></table></figure></p>
<h2 id="本地化详细过程"><a href="#本地化详细过程" class="headerlink" title="本地化详细过程"></a>本地化详细过程</h2><p>./configure的时候加上–enable-nls构建选项之后，构建过程会发生如下变化：</p>
<ol>
<li>gcc就会有-DENABLE_NLS的宏定义。从而gettext相关的代码就会被编译进去。</li>
<li>make就会处理相关国际化的内容。相关过程包含了nls.mk和nls-global.mk文件里面。</li>
</ol>
<p>每个工具比如src/bin/psql目录面都有一个nls.mk文件用来说明目录下对应工具的翻译包的生成规则，另外src文件夹下面还有一个nls-global.mk文件里面写了如何利用gettext相关工具生成翻译和安装翻译包。下面看一下他们中的内容。</p>
          
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术分享/">技术分享</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PostgreSQL/">PostgreSQL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PostgreSQL内核/">PostgreSQL内核</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/数据库/">数据库</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/本地化/">本地化</a></li></ul>
    </div>

      
        <p class="article-more-link">
          <a href="/2016/11/03/PostgreSQL本地化过程及维护/#more">阅读全文 >></a>
        </p>
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-C语言程序的国际化" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/11/02/C语言程序的国际化/" class="article-date">
      <time datetime="2016-11-02T03:37:12.000Z" itemprop="datePublished">2016-11-02</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/02/C语言程序的国际化/">C语言程序的国际化</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <blockquote>
<p>c语言程序写的时候字符串用英语，基本固定了。那么如果想让别的语言的人使用（比如中文），就得把程序里面的字符串挨个翻译，最后再重新编译一次程序维护起来特别麻烦。那么有什么办法能够让程序显示中文？GNU的gettext项目就是用来做这个的。这篇文章以c语言为例介绍了国际化的gettext。</p>
</blockquote>
<h2 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h2><p>.po文件： po，Portable Object，里面记录了翻译内容。<br>.mo文件： mo，Machine Object，其实是一个二进制文件，用来提供给程序使用。<br>xgettext：一个工具，根据c文件生成po文件<br>msgfmt： 一个工具，根据po文件生成mo文件<br>msgmerge：更新po文件</p>
<h2 id="基本过程"><a href="#基本过程" class="headerlink" title="基本过程"></a>基本过程</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">        xgettext              翻译        msgfmt          INSTALL</div><div class="line">.c文件-----------&gt;.pot文件----------&gt;.po----------&gt;.mo------------&gt;./bin/po/zh/LC_MESSAGES/.mo</div><div class="line"></div><div class="line">         gcc                              INSTALL</div><div class="line">.c文件-----------&gt;可执行文件--------------------------------------&gt;./bin</div></pre></td></tr></table></figure>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>在程序中添加这么几行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">#include &lt;libintl.h&gt;</div><div class="line">#include&lt;locale.h&gt;</div><div class="line">#define _(String) gettext (String)</div><div class="line">#define gettext_noop(String) String</div><div class="line">#define N_(String) gettext_noop (String)</div><div class="line"></div><div class="line">int main()</div><div class="line">&#123;</div><div class="line">...</div><div class="line">    setlocale (LC_ALL, &quot;&quot;);</div><div class="line">    bindtextdomain (PACKAGE, LOCALEDIR);</div><div class="line">    textdomain (PACKAGE);</div><div class="line">...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在需要翻译的字符串使用<code>_()</code>包括进来。比如如下的一个例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">#include&lt;stdio.h&gt;                                                               </div><div class="line">#include&lt;stdlib.h&gt;</div><div class="line">#include&lt;locale.h&gt;</div><div class="line">#include &lt;libintl.h&gt;</div><div class="line">#define _(String) gettext (String)</div><div class="line">#define gettext_noop(String) String</div><div class="line">#define N_(String) gettext_noop (String)</div><div class="line"></div><div class="line">#define PACKAGE &quot;main&quot;</div><div class="line">#define LOCALEDIR &quot;po&quot;</div><div class="line"></div><div class="line">int main(int argc, char *argv[])</div><div class="line">&#123;</div><div class="line">    setlocale (LC_ALL, &quot;&quot;);</div><div class="line">    bindtextdomain (PACKAGE, LOCALEDIR);</div><div class="line">    textdomain (PACKAGE);</div><div class="line">    printf(_(&quot;Hello world!\n&quot;));</div><div class="line"></div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>用xgettext程序来从.c文件中找到所有可以翻译的字符串并生成.pot模板文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">xgettext -k_ -o main.pot main.c </div><div class="line">cp main.pot main.po</div></pre></td></tr></table></figure></p>
<p>翻译po文件中的字符串，po文件的格式详见<a href="http://www.gnu.org/software/gettext/manual/html_node/PO-Files.html#PO-Files" target="_blank" rel="external">http://www.gnu.org/software/gettext/manual/html_node/PO-Files.html#PO-Files</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"># SOME DESCRIPTIVE TITLE.                                                       </div><div class="line"># Copyright (C) YEAR THE PACKAGE&apos;S COPYRIGHT HOLDER</div><div class="line"># This file is distributed under the same license as the PACKAGE package.</div><div class="line"># FIRST AUTHOR &lt;EMAIL@ADDRESS&gt;, YEAR.</div><div class="line">#</div><div class="line">#, fuzzy</div><div class="line">msgid &quot;&quot;</div><div class="line">msgstr &quot;&quot;</div><div class="line">&quot;Project-Id-Version: PACKAGE VERSION\n&quot;</div><div class="line">&quot;Report-Msgid-Bugs-To: \n&quot;</div><div class="line">&quot;POT-Creation-Date: 2016-11-02 17:31+0800\n&quot;</div><div class="line">&quot;PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n&quot;</div><div class="line">&quot;Last-Translator: FULL NAME &lt;EMAIL@ADDRESS&gt;\n&quot;</div><div class="line">&quot;Language-Team: LANGUAGE &lt;LL@li.org&gt;\n&quot;</div><div class="line">&quot;Language: \n&quot;</div><div class="line">&quot;MIME-Version: 1.0\n&quot;</div><div class="line">&quot;Content-Type: text/plain; charset=UTF-8\n&quot;</div><div class="line">&quot;Content-Transfer-Encoding: 8bit\n&quot;</div><div class="line"></div><div class="line">#: main.c:18</div><div class="line">#, c-format</div><div class="line">msgid &quot;Hello world!\n&quot;</div><div class="line">msgstr &quot;你好世界！\n&quot;</div></pre></td></tr></table></figure></p>
<p>用msgfmt从po文件生成mo文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ msgfmt ./main.po -o main.mo</div></pre></td></tr></table></figure>
<p>把mo文件放到正确的地方，注意这里的<code>po</code>文件夹是main.c里面<code>PACKAGE</code>对应的文件夹。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ mkdir -p po/zh_CN/LC_MESSAGES/</div><div class="line">$ cp ./main.mo  ./po/zh_CN/LC_MESSAGES/main.mo</div></pre></td></tr></table></figure></p>
<p>接下来要gcc编译这个程序。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gcc main.c -o main</div></pre></td></tr></table></figure></p>
<p>最后是这样的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$ tree</div><div class="line">.</div><div class="line">├── main</div><div class="line">├── main.c</div><div class="line">├── main.mo</div><div class="line">├── main.po</div><div class="line">├── main.pot</div><div class="line">└── po</div><div class="line">    └── zh_CN</div><div class="line">        └── LC_MESSAGES</div><div class="line">            └── main.mo</div><div class="line"></div><div class="line">3 directories, 6 files</div></pre></td></tr></table></figure></p>
<p>运行一下，看到已经是翻译成中文了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ ./main </div><div class="line">你好世界！</div></pre></td></tr></table></figure></p>
<h2 id="维护"><a href="#维护" class="headerlink" title="维护"></a>维护</h2><p>如果以后修改了.c文件，比如新加了一行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">    printf(_(&quot;Hello world!\n&quot;));</div><div class="line">    printf(_(&quot;Hello again!\n&quot;));</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>那么用msgmerge就可以更新原来的po文件，不需要再从头来过<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">$ xgettext --add-comments --keyword=_ main.c -o main.pot --from-code=UTF-8</div><div class="line">$ mv main.pot main.po</div><div class="line">$ msgmerge main.po.old main.po</div><div class="line">main.po: 警告： 字符集“CHARSET”不是可移植的编码名称。</div><div class="line">                将消息转换为用户字符集可能不工作。</div><div class="line">.... 完成。</div><div class="line"># SOME DESCRIPTIVE TITLE.</div><div class="line"># Copyright (C) YEAR THE PACKAGE&apos;S COPYRIGHT HOLDER</div><div class="line"># This file is distributed under the same license as the PACKAGE package.</div><div class="line"># FIRST AUTHOR &lt;EMAIL@ADDRESS&gt;, YEAR.</div><div class="line">#</div><div class="line">#, fuzzy</div><div class="line">msgid &quot;&quot;</div><div class="line">msgstr &quot;&quot;</div><div class="line">&quot;Project-Id-Version: PACKAGE VERSION\n&quot;</div><div class="line">&quot;Report-Msgid-Bugs-To: \n&quot;</div><div class="line">&quot;POT-Creation-Date: 2016-11-02 18:30+0800\n&quot;</div><div class="line">&quot;PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n&quot;</div><div class="line">&quot;Last-Translator: FULL NAME &lt;EMAIL@ADDRESS&gt;\n&quot;</div><div class="line">&quot;Language-Team: LANGUAGE &lt;LL@li.org&gt;\n&quot;</div><div class="line">&quot;Language: \n&quot;</div><div class="line">&quot;MIME-Version: 1.0\n&quot;</div><div class="line">&quot;Content-Type: text/plain; charset=UTF-8\n&quot;</div><div class="line">&quot;Content-Transfer-Encoding: 8bit\n&quot;</div><div class="line"></div><div class="line">#: main.c:18</div><div class="line">#, c-format</div><div class="line">msgid &quot;Hello world!\n&quot;</div><div class="line">msgstr &quot;你好世界！\n&quot;</div><div class="line"></div><div class="line">#: main.c:19</div><div class="line">#, fuzzy, c-format</div><div class="line">msgid &quot;Hello again!\n&quot;</div><div class="line">msgstr &quot;你好世界！\n&quot;</div></pre></td></tr></table></figure></p>
<p>可以看到Hello again被翻译成了你好世界，上面注释有fuzzy是标示这个翻译是模糊匹配的，需要人工再翻译一下。翻译过后去掉fuzzy即可。弄完之后用msgfmt再生成mo文件并拷贝到指定目录即可。当然这些都可以用Makefile来维护。稍后再写一篇PostgreSQL国际化的内容。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术分享/">技术分享</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c/">c</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/编程/">编程</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-x86-64汇编与调试" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/10/29/x86-64汇编与调试/" class="article-date">
      <time datetime="2016-10-28T23:24:09.000Z" itemprop="datePublished">2016-10-29</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/29/x86-64汇编与调试/">x86_64汇编与调试</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
              <blockquote>
<p>汇编调试如下好处：<br>1）调试Release版本，调试对象里面没有debug符号。<br>2）当C代码一行中执行了很多语句，汇编调试可以准确定位错误的情况。<br>3）可以分析栈溢出等复杂的错误。<br>掌握汇编和反汇编，会更加清楚寄存器，内存，汇编指令，程序堆栈等概念，理解C语言运行时的细节，帮助提高编程能力。</p>
</blockquote>
<h1 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h1><p><img src="http://static.zybuluo.com/shenyuflying/r7omgxk97tbzi0axk0pd211a/image_1b07j5oorei6i04o1e1usj1b0d9.png" alt="计算机结构"></p>
          
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术分享/">技术分享</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/assembly/">assembly</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gdb/">gdb</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/工具/">工具</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/编程语言/">编程语言</a></li></ul>
    </div>

      
        <p class="article-more-link">
          <a href="/2016/10/29/x86-64汇编与调试/#more">阅读全文 >></a>
        </p>
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-golang-web编程之——读取csdn最新文章" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/10/29/golang-web编程之——读取csdn最新文章/" class="article-date">
      <time datetime="2016-10-28T22:35:08.000Z" itemprop="datePublished">2016-10-29</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/29/golang-web编程之——读取csdn最新文章/">golang web编程之——读取csdn最新文章</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <blockquote>
<p>利用go语言内置的各种网络包可以方便的进行web编程。本文章利用了csdn的<a href="http://open.csdn.net/wiki/apis" target="_blank" rel="external">开放API</a>实现读取最新文章的需求。演示了go语言发起http get请求和json的umarshing特性。</p>
</blockquote>
<h2 id="简单的http-GET请求"><a href="#简单的http-GET请求" class="headerlink" title="简单的http GET请求"></a>简单的http GET请求</h2><p>go语言内置了<code>net/http</code>包，采用<code>http.Get</code>能够方便的发起GET请求</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"io/ioutil"</span></div><div class="line">	<span class="string">"log"</span></div><div class="line">	<span class="string">"net/http"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line"></div><div class="line">	resp, err := http.Get(<span class="string">"http://api.csdn.net/blog/getnewarticlelist?client_id=????&amp;page=1&amp;size=10"</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatal(err)</div><div class="line">	&#125;</div><div class="line">	contents, err := ioutil.ReadAll(resp.Body)</div><div class="line">	resp.Body.Close()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatal(err)</div><div class="line">	&#125;</div><div class="line">	fmt.Printf(<span class="string">"%s"</span>, contents)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看到返回的内容为json格式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&quot;page&quot;:1,&quot;count&quot;:12733,&quot;size&quot;:10,&quot;list&quot;:[&#123;&quot;ArticleId&quot;:52963517,&quot;BlogId&quot;:5022393,&quot;UserName&quot;:&quot;u013410747&quot;,&quot;Title&quot;:&quot;linux修改默认的编辑器&quot;,&quot;Description&quot;:&quot;sudo select-editor    选择vim 搞定。。&quot;,&quot;PostTime&quot;:&quot;\/Date(1477712141000)\/&quot;,&quot;UpdateTime&quot;:&quot;\/Date(1477712177908)\/&quot;,&quot;Digg&quot;:0,&quot;Bury&quot;:0,&quot;ChannelId&quot;:2,&quot;Type&quot;:1,&quot;Status&quot;:0,&quot;ViewCount&quot;:0,&quot;CommentCount&quot;:0,&quot;CommentAuth&quot;:2,&quot;IsTop&quot;:false,&quot;Level&quot;:0,&quot;OutlinkCount&quot;:0,&quot;Note&quot;:null,&quot;IP&quot;:null,&quot;Categories&quot;:null,&quot;Tags&quot;:[],&quot;ColumnAlias&quot;:null,&quot;ColumnTitle&quot;:null,&quot;MarkDownContent&quot;:null,&quot;MarkDownDirectory&quot;:null,&quot;ArticleEditType&quot;:0,&quot;ArticleMore&quot;:null&#125;,...umnAlias&quot;:null,&quot;ColumnTitle&quot;:null,&quot;MarkDownContent&quot;:null,&quot;MarkDownDirectory&quot;:null,&quot;ArticleEditType&quot;:0,&quot;ArticleMore&quot;:null&#125;]&#125;成功: 进程退出代码 0.</div></pre></td></tr></table></figure>
<h2 id="JSON转为内部结构体"><a href="#JSON转为内部结构体" class="headerlink" title="JSON转为内部结构体"></a>JSON转为内部结构体</h2><p>那么如何把json格式的内容转为golang的内部结构体呢？这需要利用<code>json.Unmarshal</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"encoding/json"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"io/ioutil"</span></div><div class="line">	<span class="string">"log"</span></div><div class="line">	<span class="string">"net/http"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> Article <span class="keyword">struct</span> &#123;</div><div class="line">	ArticleId   <span class="keyword">int</span></div><div class="line">	BlogId      <span class="keyword">int</span></div><div class="line">	UserName    <span class="keyword">string</span></div><div class="line">	Title       <span class="keyword">string</span></div><div class="line">	Description <span class="keyword">string</span></div><div class="line">	PostTime    <span class="keyword">string</span></div><div class="line">	UpdateTime  <span class="keyword">string</span></div><div class="line">	ViewCount    <span class="keyword">int</span></div><div class="line">	CommentCount <span class="keyword">int</span></div><div class="line">	Categories  <span class="keyword">int</span></div><div class="line">	ColumnAlias <span class="keyword">bool</span></div><div class="line">	Url         <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">type</span> Articles <span class="keyword">struct</span> &#123;</div><div class="line">	Page  <span class="keyword">int</span> <span class="string">`json:"page,int"`</span></div><div class="line">	Count <span class="keyword">int</span></div><div class="line">	Size  <span class="keyword">int</span></div><div class="line">	List  []*Article</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	resp, err := http.Get(<span class="string">"http://api.csdn.net/blog/getnewarticlelist?client_id=????&amp;page=0&amp;size=20"</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatal(err)</div><div class="line">	&#125;</div><div class="line">	str, err := ioutil.ReadAll(resp.Body)</div><div class="line">	resp.Body.Close()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatal(err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> contents Articles</div><div class="line">	<span class="keyword">if</span> err := json.Unmarshal(str, &amp;contents); err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatal(<span class="string">"Json unmarshing failed: "</span>, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> k, v := <span class="keyword">range</span> contents.List &#123;</div><div class="line">		fmt.Printf(<span class="string">"%v. %v\n"</span>, k, v.Title)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后，我们完成了用csdn的<a href="http://open.csdn.net/wiki/apis" target="_blank" rel="external">开放API</a>实现读取最新文章的需求。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">0. 1048. Find Coins (25)解题报告</div><div class="line">1. 1049. Counting Ones (30)解题报告</div><div class="line">2. java实习第二天</div><div class="line">3. 1060. 爱丁顿数(25)</div><div class="line">4. 剑指offer-数组中出现次数超过一半的数字</div><div class="line">5. jsonp跨域访问案例</div><div class="line">6. framework jar包MAKEFILE示例</div><div class="line">7. Unity3d 乱序之惑</div><div class="line">8. CodeForces 445C DZY Loves Physics</div><div class="line">9. LeetCode #424: Longest Repeating Character Replacement</div><div class="line">10. 面板显示private变量用标签[SerializeField]</div><div class="line">11. PostgreSQL问题解决--连接数过多</div><div class="line">12. 多维高斯分布及多维条件高斯分布</div><div class="line">13. 王朝  都要学C</div><div class="line">14. CharacterController.Move 实现角色移动</div><div class="line">15. bootargs</div><div class="line">16. 不用输入法输自己的名字!!!!</div><div class="line">17. mybatis mbg自动生成的selectByExample按条件查询不出来值。</div><div class="line">18. 系统乔迁留念贴</div><div class="line">19. java中Proxy(代理与动态代理)</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/技术分享/">技术分享</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/golang/">golang</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/编程语言/">编程语言</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/5/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/7/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2014-2017 小宇
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit"  title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





    <script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>